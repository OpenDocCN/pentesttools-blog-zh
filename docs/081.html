<html>
<head>
<title>How to detect VMware vCenter RCE with Pentest-Tools.com (CVE-2021-21972) | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何检测 Pentest-Tools.com(CVE-2021-21972)| Pentest-Tools.com 的 VMware vCenter RCE</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/vmware-rce-cve-2021-21972#2022-07-07T07:40:41.000Z">https://pentest-tools.com/blog/vmware-rce-cve-2021-21972#2022-07-07T07:40:41.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>大型组织运行的当前多层设置是一个管理挑战，我们都知道这一点(这是一种保守的说法)。当像 CVE-2021-21972 这样的漏洞出现时，它揭示了修补和缓解过程是多么混乱。</p><p>但是，唯一的办法就是通过！因为发现和报告漏洞是我们帮助您完成的任务，所以我们通常会深入研究这些漏洞，这样您就不必付出额外的努力。</p><p>让我们从一个快速的时间表开始，解开这个特殊的 CVE。</p><p>2021 年 2 月 23 日，VMWare 发布了 CVE-2021-21972 的补丁(VMSA-2021-0002)。在他们的安全公告中，他们还提到了在 VMWare ESXi 虚拟机管理程序中发现的另一个漏洞。</p><p>第二天，安全专家<a target="_blank" href="https://swarm.ptsecurity.com/author/mikhail-klyuchnikov/" rel="external nofollow noopener noreferrer"> Mikhail Klyuchnikov </a>发表了一篇<a target="_blank" href="https://swarm.ptsecurity.com/unauth-rce-vmware/" rel="external nofollow noopener noreferrer">博文</a>，详细介绍了 VMWare vCenter 的 vSphere Client 组件中的两个关键漏洞:</p><p>让我们补充一点背景知识。</p><h2 id="what-is-vmware-vsphere"><strong>什么是 VMware vSphere？</strong></h2><p><a target="_blank" href="https://docs.vmware.com/en/VMware-vSphere/index.html" rel="external nofollow noopener noreferrer"> VMware vSphere </a>是 VMware 的虚拟化平台，它将数据中心转变为包含 CPU、存储和网络资源的聚合计算基础架构。vSphere 将这些基础架构作为统一的操作环境进行管理，并为您提供管理参与该环境的数据中心的工具。</p><p><img src="../Images/f653dc18cc6800f075ac5805b3401d97.png" alt="VMware vSphere" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi92bXdhcmUtdnNwaGVyZS5wbmc=?s=b4cc9f332f2af95919892b77a7383e14"/></p><p>vSphere 的两个核心组件是 ESXi 和 vCenter Server:</p><ul><li><p>ESXi 是您创建和运行虚拟机和虚拟设备的虚拟化平台</p></li><li><p>vCenter Server 是一项服务，您可以通过它来管理网络中连接的多台主机并共享主机资源。</p></li></ul><h2 id="how-the-vmware-vcenter-rce-vuln-works"><strong>VMware vCenter RCE vuln 的工作原理</strong></h2><p>vSphere Client (HTML5)受到 vCenter Server 插件中的远程代码执行漏洞的影响。对端口 443 具有网络访问权限的恶意参与者可以利用此问题，在托管 vCenter Server 的底层操作系统上以不受限制的权限执行命令。</p><p>该病毒被追踪为<a target="_blank" href="https://nvd.nist.gov/vuln/detail/CVE-2021-21972" rel="external nofollow noopener noreferrer"> CVE-2021-21972 </a>影响:</p><ul><li><p>VMware vCenter Server(7.0 U1c 之前的 7.x、6.7 U3l 之前的 6.7 以及 6.5 U3n 之前的 6.5)</p></li><li><p>VMware 云基础(4.2 之前的 4.x 和 3.10.1.2 之前的 3.x)。</p></li></ul><p>由于大量公司在其网络上运行 VMWare vCenter，积极技术公司<a target="_blank" href="https://twitter.com/ptswarm/status/1364323986251907072" rel="external nofollow noopener noreferrer">最初计划</a>在系统管理员有足够的时间应用补丁之前，将关于这一关键漏洞的技术细节和概念验证保密。<br/>然而，<a target="_blank" href="http://noahblog.360.cn/vcenter-6-5-7-0-rce-lou-dong-fen-xi/" rel="external nofollow noopener noreferrer">一名中国研究员</a>和其他 infosec 分析师发布了一个概念验证代码，有效地迫使受此漏洞影响的公司应用补丁。此外，他们开始对易受攻击的 vCenter 系统进行大规模扫描，这些系统保持在线连接，而攻击者则匆忙破坏这些系统。</p><h2 id="how-cve-2021-21972-exposes-your-system-to-remote-exploitation"><strong>CVE-2021-21972 如何将您的系统暴露给远程利用</strong></h2><p><a target="_blank" href="https://blogs.vmware.com/management/2018/04/vrealize-operations-within-vcenter-plugin.html" rel="external nofollow noopener noreferrer"> vRealize Operations vCenter 插件</a>是此漏洞的根本原因。攻击者可以通过加载精心编制的文件来远程利用易受攻击的系统。这就是公司尽快应用可用补丁程序如此重要的原因。<br/>但是在我们深入探讨修补细节之前，我们必须对<strong> CVE-2021-21972 </strong>有一个深入的了解。</p><h3 id="details-and-analysis-of-the-vulnerability"><strong>漏洞详情及分析</strong></h3><p>vSphere Client 中存在 vuln，因为<em>/ui/vropspluginui/rest/services/*</em>端点不需要身份验证。<br/>在上述端点中，易受攻击的函数是 uploadOvaFile，URL<em>/ui/vropspluginui/rest/services/uploadova</em>允许上传恶意 jsp 外壳，这使得未经验证的攻击者能够远程执行代码。<br/>upload ova 函数的处理程序允许您将任意文件上传到 vCenter server 上的任意位置。</p><p>对于 Windows 系统，对手可以上传一个精心制作的。jsp shell 文件，以便<strong>获得服务器</strong>上的管理权限。</p><p>对于 Linux 系统，恶意参与者可以生成 SSH 公钥并上传到服务器上的 authorized_keys 文件。因此，他们可以通过易受攻击的服务器上的 SSH 进行连接。</p><p><img src="../Images/aa47d7b63971d68bab514b883031291f.png" alt="vuln windows system" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi93aW5kb3dzLnBuZw==?s=73cc2b48d851e58b84d22f75aea153c7"/>易受攻击的 Windows 系统<br/>来源:<a target="_blank" rel="external nofollow noopener noreferrer" href="https://swarm.ptsecurity.com/unauth-rce-vmware/">积极科技</a></p><p><img src="../Images/7c6699b6eefc151ceb3f26ba11be76d1.png" alt="vuln linux system" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi9saW51eC5wbmc=?s=879c582329fe0751142754295ac176c6"/>易受攻击的 Linux 系统<br/>来源:<a target="_blank" rel="external nofollow noopener noreferrer" href="https://swarm.ptsecurity.com/unauth-rce-vmware/">正面技术</a></p><h2 id="business-impact"><strong>业务影响</strong></h2><p>如果成功利用，此漏洞将允许未经验证的攻击者在<em> vsphere-ui </em>用户的上下文中获得远程代码执行飞机的“VIP 票”，目的地为 vCenter。</p><p>在撰写本文时，我们发现了通过<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.shodan.io/"> Shodan </a>注册的<strong> 6851 </strong>潜在易受攻击的目标。</p><p><img src="../Images/86c15c055c11a4c285ae16691ff61a99.png" alt="shodan" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi9zaG9kYW4ucG5n?s=3c0bb874202d99df0a061bd79fdc4b96"/>你可以从这个基本的 Shodan 查询:<em>http . title:" idvc welcome "</em>开始，自己尝试搜索、寻找<strong>教育目的的潜在目标</strong>。</p><blockquote><p><em>从🇦🇱🇧🇷🇨🇦🇨🇳🇩🇪🇭🇰🇮🇳🇮🇩🇯🇵🇳🇱🇷🇺🇸🇬🇰🇷🇨🇭🇦🇪🇬🇧🇺🇸🇻🇳的主机中检测到针对易受远程代码执行攻击的 VMware vCenter 服务器的机会主义大规模扫描活动(CVE-2021-21972)。<a href="https://twitter.com/hashtag/threatintel?src=hash&amp;ref_src=twsrc%5Etfw" rel="external nofollow noopener noreferrer">#威胁</a><a href="https://t.co/kOfqzW2Rmi" rel="external nofollow noopener noreferrer">https://t.co/kOfqzW2Rmi</a></em></p><p><em> —坏数据包(@ Bad _ Packets)<a href="https://twitter.com/bad_packets/status/1365194425584902147?ref_src=twsrc%5Etfw" rel="external nofollow noopener noreferrer">2021 年 2 月 26 日</a> </em></p></blockquote><p><br/>根据您的操作系统和环境，攻击者利用此 CVE 会产生不同程度的后果:</p><ul><li><p>如果威胁参与者能够成功利用此漏洞，他们就可以在 vCenter Server 的底层操作系统中远程执行代码。</p></li><li><p>对于 Windows 主机，攻击者可以上传恶意的。jsp 文件并获得服务器上的系统权限。</p></li><li><p>对于 Linux 服务器，攻击者需要生成一个 SSH 公钥并上传到。ssh 目录，并通过 SSH 连接到易受攻击的服务器。</p></li><li><p>任何能够到达易受攻击的 vCenter server 上的端口 443 的恶意黑客都可以完全获取数据信息，并危及设备及其包含的任何虚拟机。</p></li></ul><p>无论哪种情况更有可能发生在你身上，后果都…不太好。</p><h2 id="how-to-detect-cve-2021-21972-when-your-endpoint-protection-doesnt"><strong>当您的终端防护无法检测到 CVE-2021-21972 时，如何进行检测</strong></h2><p>如果您的终端安全解决方案无法检测到这一严重缺陷，这里有一种更简单的方法。查看 vCenter 日志并查找对<em>/ui/vropspluginui/rest/services/uploadova</em>端点的访问。</p><p>消除工作流程中的摩擦是我们的专长，因此这里介绍如何在不使用额外工具的情况下完成这项工作。登录您的<a target="_blank" href="https://pentest-tools.com">Pentest-Tools.com</a>账户<br/>。<br/>在工具下，查看 Web 应用测试菜单，选择<strong>使用 OpenVAS 进行网络漏洞扫描</strong>。</p><p><img src="../Images/e5811b9bd90608f08a32ebc63cd1da76.png" alt="select scanner" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi9zZWxlY3Qtc2Nhbm5lci5wbmc=?s=358ad627f055e6a7adde6b2c960774ea"/>在扫描仪的配置中，设置您的目标 URL 并选择“全面扫描”选项。<br/> Do <strong> not </strong>添加任何认证方法，因为您的目标是找到您可以访问<em>而无需</em>授权的资源。如果您想有效地利用时间，请选择在扫描完成时收到电子邮件通知。</p><p><img src="../Images/3429efb644e5ec6dbccca168069dc4c7.png" alt="start a scan" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi9zdGFydC1zY2FuLnBuZw==?s=f0f5443b76f5d72fe92baa2c864d2323"/>一旦扫描程序结束，你可以浏览结果，看看你是否容易受到 CVE-2021-21972 的攻击。</p><p><img src="../Images/e0cafe40d76956ea2b2078ee7ecee877.png" alt="scan results" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvdm13YXJlLXJjZS1jdmUtMjAyMS0yMTk3Mi9zY2FuLXJlc3VsdHMucG5n?s=f5fd1677442eec382c9faaa8bdfbbee3"/>如果您需要以 PDF、HTML 或可定制的 DOCX 格式传递此特定问题，您还可以导出一份快速报告。</p><h2 id="how-to-mitigate-cve-2021-21972"><strong>如何缓解 CVE-2021-21972 </strong></h2><p>我们建议开始在您的环境中应用可用的补丁，因为 VMWare 已经发布了针对 CVE-2021-21972 的补丁。</p><div class="flex flex-col"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6"><div class="inline-block min-w-full py-2 align-middle sm:px-6"><div class="border border-gray-200 bg-white overflow-hidden shadow sm:rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead><tr><td colspan="1" rowspan="1">产品版本&gt;</td><td colspan="1" rowspan="1">固定版本</td><td colspan="1" rowspan="1">月份地址</td></tr></thead><tr><td colspan="1" rowspan="1">vCenter Server 7.0</td><td colspan="1" rowspan="1">7.0 U1c</td><td colspan="1" rowspan="1">2020 年 12 月</td></tr><tr><td colspan="1" rowspan="1">vCenter Server 6.7</td><td colspan="1" rowspan="1">6.7 U3l</td><td colspan="1" rowspan="1">2020 年 11 月</td></tr><tr><td colspan="1" rowspan="1">vCenter Server 6.5</td><td colspan="1" rowspan="1">6.5 U3n</td><td colspan="1" rowspan="1">2021 年 2 月</td></tr><tr><td colspan="1" rowspan="1">云基础 3.x</td><td colspan="1" rowspan="1">3.10.1.2</td><td colspan="1" rowspan="1">2021 年 2 月</td></tr><tr><td colspan="1" rowspan="1">云基础 4.x</td><td colspan="1" rowspan="1">4.2</td><td colspan="1" rowspan="1">2021 年 2 月</td></tr></table></div></div></div></div><p>如果您无法立即做到这一点，VMWare 为 CVE-2021-21972 和 CVE-2021-21973 提供了变通解决方案。系统管理员需要更改兼容性列表文件，并将 vRealize Operations vCenter 插件设置为不兼容。</p><h2 id="vms-are-great-if-you-constantly-keep-an-eye-on-them"><strong>虚拟机很棒——如果你持续关注它们的话</strong></h2><p>全球企业都在运行 VMware 技术，以便更轻松地管理其 IT 基础架构和自动化工作负载。虽然这种云解决方案有助于组织提高 IT 效率，但未安装补丁的 vCenter servers 可能会给他们带来一系列安全问题。</p><p>定期监控是确保业务连续性的必备条件，定期扫描(你也可以在 Pentest-Tools.com<a href="https://pentest-tools.com">网站</a>上获得)是一种在潜在问题升级之前发现它们的简单方法。</p><p>我们的团队一直致力于在<a href="https://pentest-tools.com">Pentest-Tools.com</a>上添加新功能和改进工具(现在有 25 个以上)，这样你就可以快速检测出漏洞。</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>