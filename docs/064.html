<html>
<head>
<title>The 17-year-old DNS vulnerability that leads to RCE in Windows | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>导致 Windows | Pentest-Tools.com RCE 的 17 年之久的 DNS 漏洞</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/sigred-dns-windows-rce#2022-07-07T10:24:23.000Z">https://pentest-tools.com/blog/sigred-dns-windows-rce#2022-07-07T10:24:23.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>在之前的博客中，我们揭示了 web 应用程序、防火墙、SMB 协议中的漏洞，现在我们有了一个 DNS 漏洞。</p><p>这证明每个服务、网络协议和应用程序都容易受到攻击。</p><p>只要设备连接到互联网，它就会成为潜在的目标。(即使那些不在线的也可能被滥用，使用集中于硬件振动的数据渗透技术，但那是另一天的话题。)</p><p>所以，让我们回到今天的主要话题:CVE-2020-1350(也称为 SIGRed)，这是一个在 Windows DNS 服务器中发现的高风险漏洞，可以导致远程代码执行，甚至更糟的是，导致整个基础设施受损。</p><p>你准备好认真对待事实了吗？</p><h2 id="vulnerability-overview">漏洞概述</h2><p>这么大(甚至巨大！)在 Windows DNS 服务器协议中发现安全问题。它的概念非常类似于 SMBGhost(您可以使用我们的技术演练将其链接到 SMBleed)。</p><p>它获得了可能的最高 CVSS 奖——10/10——有两个原因:</p><ul><li><p>此漏洞可导致远程代码执行，从而将其影响提升至严重级别</p></li><li><p>而且它的开发复杂度也在中等偏上。</p></li></ul><p>事实上，它在雷达下停留了超过 17 年，使情况变得更糟。</p><p>自其披露以来，网络犯罪分子开始如预期的那样在野外滥用它。</p><h3 id="whats-the-story-behind-the-sigred-name">“SIGRed”这个名字背后有什么故事？</h3><p>名称中的“SIG”来自“Signature record”，这是一种用于携带不同细节的 DNS，包括签名的加密算法、签名人姓名、到期时间以及关于客户端发送的特定 DNS 查询的更多信息。名称中的“红色”是指这个问题是一个关键问题。</p><p>还记得和<a href="http://localhost:3000/blog/how-to-detect-microsoft-smbghost-vulnerability/" rel="external nofollow noopener noreferrer"> <strong> <u> SMBGhost </u> </strong> </a>的相似之处吗？这个 vuln 和著名的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010"> <strong> <u>永恒蓝</u> </strong> </a>也有共同之处。而且是很简单的一个方面:<strong>Windows 相关网络协议中的缓冲区溢出</strong>。</p><p>最初，SIGRed 是通过 DNS 查询的缓冲区溢出，当被 Windows DNS 服务器解释时，SIG 标志值超标。</p><h2 id="affected-versions">受影响的版本</h2><p>你可以在 2003 年到 2019 年每一个未打补丁的 Windows Server 版本<strong>中找到这个漏洞。哎哟。</strong></p><h2 id="technical-aspects">技术方面</h2><p>大多数人将矛头指向 Windows DNS 服务器实现中有罪的“SigWireRead”函数，即“dns.exe”进程。此函数负责解释来自 DNS 查询的 SIG 和 RRSIG 值。</p><p>SigWireRead 函数有一个名为“RR_AllocateEx”的子函数，它为 SIG 和 RRSIG 值分配内存，并通过 memcpy 传递分配的内存地址，memcpy 是一个通常与基于堆的缓冲区溢出相关的函数。</p><p>通过从客户端发送 SIG/RRSIG 值大于 64KB 的 DNS 响应，您可以触发受控的缓冲区溢出，这最终会导致服务崩溃(拒绝服务),甚至更糟的是远程代码执行。</p><h2 id="impact">影响</h2><p>如果(什么时候？)利用此漏洞，您可以获得远程代码执行列车的 VIP 票，目的地为 Windows Server。小心，那些到达那里的人被称为“域管理员”！</p><p>Windows DNS 服务器是每个基于 Windows 的环境的核心组件，也常用于 Active Directory 中。此外，<strong>该漏洞被标记为“可蠕虫攻击的”</strong>，这意味着，在利用后，<strong>攻击者可以通过您的网络</strong>执行横向和纵向移动，从而导致潜在的全面危害。</p><p>在编写本报告时，通过 Shodan 登记的可能易受攻击的目标约有 23，244 个。</p><p>从这个基本的 Shodan 查询:<code>port:53 “Microsoft DNS”</code>开始，您可以尝试自己搜索并找到用于教育目的的潜在目标。</p><h2 id="exploit-overview">漏洞利用概述</h2><p>在撰写本文时，迄今为止您能找到的唯一可用漏洞是 GitHub   上的一个<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/maxpl0it/CVE-2020-1350-DoS"> <strong> <u> DoS one，它滥用 SIGRed 漏洞使 DNS 服务崩溃。</u></strong></a></p><p>利用原则是利用 DNS 服务器解析转发的 SIG-tagged(或 RRSIG)查询响应的方式。</p><p><img src="../Images/8d92839b68e1ff230f4b00e6e9a4c0b0.png" alt="Windows DNS vulnerability exploitation graphic" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvc2lncmVkLWRucy13aW5kb3dzLXJjZS93aW5kb3dzLWRucy12dWxuZXJhYmlsaXR5LWV4cGxvaXRhdGlvbi1ncmFwaGljLnBuZw==?s=49f3003a9581b3eaccc867bf34aeab0b"/>使用 Github   的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/maxpl0it/CVE-2020-1350-DoS"> <strong> <u> Python 脚本，可以托管自己的恶意域名，之后会如下运行:</u></strong></a></p><ol start="1"><li><p>从攻击者的机器上，使用以下命令通过易受攻击的 DNS 服务器发送针对恶意域的 SIG-records DNS 查询:<code>nslookup -type=sig {subdomain.attacker_domain} {vulnerable server IP}</code></p></li><li><p>易受攻击的 DNS 服务器将向公共 DNS 服务器询问恶意域的域名服务器</p></li><li><p>攻击者的 DNS 服务器的名称服务器被返回给易受攻击的 Windows DNS 服务器</p></li><li><p>易受攻击的 DNS 将充当客户端，并将初始 SIG 请求查询转发到攻击者的 DNS 服务器</p></li><li><p>通过我们的脚本，恶意 DNS 服务器将使用恶意 SIG 值进行响应，该恶意 SIG 值被精心编制以产生缓冲区溢出并使受害服务器上的 DNS 服务崩溃。</p></li></ol>

                

                
              
                
                  <div x-data="{ showVideo: false }" x-on:close.window.stop="showVideo = false" class="not-prose group relative flex items-center justify-center overflow-hidden rounded-xl">
  
  <p aria-hidden="true" class="pointer-events-none absolute inset-0 rounded-xl bg-gray-800 opacity-40"/>
  <p aria-hidden="true" class="absolute h-28 w-28 overflow-hidden rounded-full bg-white bg-opacity-5 shadow-lg ring-1 ring-white ring-opacity-20 transition duration-300 supports-backdrop-filter:backdrop-blur-sm group-hover:scale-110 group-hover:bg-opacity-10 group-hover:ring-opacity-30 sm:h-32 sm:w-32 lg:h-36 lg:w-36"/>
  <button type="button" aria-haspopup="true" x-bind:aria-expanded="showVideo ? showVideo : undefined" class="group absolute inset-0 flex w-full items-center justify-center rounded-3xl focus:outline-none" x-on:click="showVideo = true">
    <span class="sr-only">Play video</span>
    <svg class="h-24 w-24 rounded-full ring-offset-4 ring-offset-transparent transition-[box-shadow,transform] duration-300 group-hover:scale-105 group-focus:ring-4 group-focus:ring-white group-focus:ring-opacity-30 sm:h-28 sm:w-28 lg:h-32 lg:w-32" aria-hidden="true" viewbox="0 0 24 24" fill="none">
      <path class="text-white transition-[text-opacity] duration-300" fill="currentColor" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      <path class="text-secondary-accent-500" fill="currentColor" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
    </svg>
  </button>

  
  

  <template x-if="showVideo">
    
















<template x-teleport="body">
  <div x-data="modal" class="fixed inset-0 z-120 overflow-hidden overflow-y-auto" x-on:keydown.escape.window.prevent.stop="close" x-on:close.window="close" x-show="open">
    <div class="flex h-full justify-center items-center px-4 pt-4 pb-16 sm:p-0">
      <p x-show="open" x-transition.opacity="" aria-hidden="true" class="fixed inset-0 bg-gray-500/75 transition-opacity" x-on:click.stop="close"/>

      
      

      <div x-show="open" x-transition:enter="duration-300 ease-out" x-transition:enter-start="translate-y-4 opacity-0 sm:translate-y-0 sm:scale-95" x-transition:enter-end="translate-y-0 opacity-100 sm:scale-100" x-transition:leave="duration-200 ease-in" x-transition:leave-start="translate-y-0 opacity-100 sm:scale-100" x-transition:leave-end="translate-y-4 opacity-0 sm:translate-y-0 sm:scale-95" role="dialog" aria-modal="true" aria-labelledby="modal-headline" class="transform transition-[opacity,transform] sm:my-8 h-auto sm:w-auto" x-trap.noscroll.inert="open" x-on:transitionend.self.debounce="$focus.first()">
        <div class="relative sm:w-screen sm:max-w-xl lg:max-w-3xl xl:max-w-5xl">
        <h2 id="modal-title" class="sr-only">如何利用导致 Windows RCE 的 17 岁 DNS 漏洞 SIGRed(CVE-2020-1350)</h2>
        
        <p class="aspect-video overflow-hidden rounded-lg">                    </p>
      </div>
      </div>
    </div>
  </div>
</template>


  


  </template>
</div>



                

                
              
                
                  <h2 id="how-to-fix-cve-2020-1350">如何修复 CVE-2020-1350</h2><p>最好的做法是<strong>立即修补</strong>，你可以用两种方式做到这一点:</p><ol start="1"><li><p>使机器联机并检查 Windows 更新(如果没有自动安装)</p></li><li><p>使用此<a target="_blank" rel="external nofollow noopener noreferrer" href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350"> <strong> <u>链接</u> </strong> </a>手动下载更新。</p></li></ol><p>如果您不能修补服务器，有一个基于注册表的解决方法(不推荐，但总比没有好):</p>

                

                
              
                
                  <div class="not-prose my-10">
                    

<div x-data="{&#10;  activeTab: 'registry',&#10;  copied: false,&#10;&#10;  setActiveTab(tab) {&#10;    this.activeTab = tab&#10;  },&#10;  async copyCode() {&#10;    const code = this.$refs[`code-${this.activeTab}`]&#10;&#10;    if (!code) return&#10;    if (!code.textContent) return&#10;&#10;    await navigator.clipboard.writeText(code.textContent.trim())&#10;    this.copied = true&#10;    await new Promise((resolve) =&gt; setTimeout(resolve, 1000))&#10;    this.copied = false&#10;  },&#10;}" class="not-prose code-block-group relative z-10 -mx-6 flex max-w-2xl flex-col sm:mx-0 xl:sticky xl:top-26 xl:h-auto xl:max-h-128">
  <div class="relative flex h-full overflow-hidden bg-[#011627] shadow-2xl shadow-dark-blue-300 sm:rounded-xl">
    <div class="relative flex w-full flex-col">
      
        
      

      <div class="relative z-10 flex min-h-0 flex-auto flex-col border-t border-white border-opacity-10">
        

        <div class="group flex min-h-0 flex-auto flex-col">
          <div x-show="'registry' === activeTab" class="code-block relative flex min-h-0 w-full flex-auto flex-col">
  <p aria-hidden="true" class="absolute inset-y-0 left-0 z-10 w-12 bg-[#00111f]"/>

  <div x-ref="code-registry" class="content-highlight h-full min-h-0 flex-auto overflow-auto">
    <pre class="shiki"><code><span class="line"><span>HKEY_LOCAL_MACHINE</span><span>\S</span><span>YSTEM</span><span>\C</span><span>urrentControlSet</span><span>\S</span><span>ervices</span><span>\D</span><span>NS</span><span>\P</span><span>arameters</span></span>
<span class="line"><span>DWORD = TcpReceivePacketSize</span></span>
<span class="line"><span>Value = 0xFF00</span></span></code></pre>
  </div>

  
</div>
        </div>
      </div>
    </div>
  </div>
</div>

                  </div>

                

                
              
                
                  <p>将它添加到 Windows 注册表中后，以管理员身份打开 CMD 并输入以下命令来重新启动 DNS 服务:</p>

                

                
              
                
                  <div class="not-prose my-10">
                    

<div x-data="{&#10;  activeTab: 'dns',&#10;  copied: false,&#10;&#10;  setActiveTab(tab) {&#10;    this.activeTab = tab&#10;  },&#10;  async copyCode() {&#10;    const code = this.$refs[`code-${this.activeTab}`]&#10;&#10;    if (!code) return&#10;    if (!code.textContent) return&#10;&#10;    await navigator.clipboard.writeText(code.textContent.trim())&#10;    this.copied = true&#10;    await new Promise((resolve) =&gt; setTimeout(resolve, 1000))&#10;    this.copied = false&#10;  },&#10;}" class="not-prose code-block-group relative z-10 -mx-6 flex max-w-2xl flex-col sm:mx-0 xl:sticky xl:top-26 xl:h-auto xl:max-h-128">
  <div class="relative flex h-full overflow-hidden bg-[#011627] shadow-2xl shadow-dark-blue-300 sm:rounded-xl">
    <div class="relative flex w-full flex-col">
      
        
      

      <div class="relative z-10 flex min-h-0 flex-auto flex-col border-t border-white border-opacity-10">
        

        <div class="group flex min-h-0 flex-auto flex-col">
          <div x-show="'dns' === activeTab" class="code-block relative flex min-h-0 w-full flex-auto flex-col">
  <p aria-hidden="true" class="absolute inset-y-0 left-0 z-10 w-12 bg-[#00111f]"/>

  <div x-ref="code-dns" class="content-highlight h-full min-h-0 flex-auto overflow-auto">
    <pre class="shiki"><code><span class="line"><span>net stop dns</span></span>
<span class="line"><span>net start dns</span></span></code></pre>
  </div>

  
</div>
        </div>
      </div>
    </div>
  </div>
</div>

                  </div>

                

                
              
                
                  <p>鉴于 SIGRed 的性质和流行程度，<strong>我们预计我们将更新这篇文章，提供新的漏洞或重要细节</strong>，所以如果你打算关注这种情况，请确保将它加入书签。</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>