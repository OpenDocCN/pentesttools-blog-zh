<html>
<head>
<title>The DMARC protocol email security | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>DMARC协议电子邮件安全| Pentest-Tools.com</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/dmarc-protocol-email-security#2023-01-30T14:19:31.000Z">https://pentest-tools.com/blog/dmarc-protocol-email-security#2023-01-30T14:19:31.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>在本文中，您将熟悉DMARC，这是一种鲜为人知的电子邮件安全协议，可以帮助企业防止网络钓鱼活动。</p><p>看完这篇文章，你会知道:</p><ul><li><p>什么是DMARC以及它为什么有用</p></li><li><p>攻击者如何从错误配置的DMARC策略中获利</p></li><li><p>如何修复易受攻击的实例。</p></li></ul><h2 id="disclaimer">放弃</h2><p>您将要阅读的内容严格用于教育目的。我们不允许将这些知识用于非法活动。</p><h2 id="what-is-dmarc-and-why-do-you-need-it"><strong>什么是DMARC，为什么需要它？</strong></h2><p>DMARC代表基于域的消息认证、报告和一致性。简而言之，这是一种验证您发送的电子邮件的方法。它通过指定所需策略的DNS记录来实现。<br/></p><p>鉴于大多数网络攻击始于网络钓鱼活动，DMARC安全性是一个重要因素。如果配置不当，会造成很大的损害。<br/></p><p>DMARC允许组织通过防止攻击者使用其域名和子域名进行网络钓鱼攻击来保护其品牌和声誉。这可以帮助用户免于成为此类攻击的受害者，还可以防止组织卷入欺诈活动。</p><p>使用策略验证电子邮件发件人。DMARC告诉接收邮件服务器，当它们收到看似来自您的组织但未通过身份验证检查的邮件时，该如何处理。</p><p>DMARC建立在密钥认证标准<strong> SPF </strong>(发件人策略框架)和<strong> DKIM </strong>(域密钥识别邮件)的基础上。它补充了用于发送电子邮件的基本协议SMTP，因为<strong> SMTP </strong>不包括任何用于实现或定义电子邮件认证策略的机制。</p><p>SMTP(简单邮件传输协议)始于1980年，从那时起，它就成为发送电子邮件的首选协议。因为SMTP在创建时没有考虑安全性，所以它不包含任何安全机制。这就是为什么专家必须创建像DMARC这样的电子邮件安全协议来帮助防止欺骗和欺诈。</p><h2 id="why-is-the-dmarc-protocol-so-important">为什么DMARC协议如此重要？</h2><p>电子邮件安全是网络安全中最少涉及的话题之一，尽管它有一定的影响。</p><p>在构建分层防御策略时，组织可以遵循所有推荐的准则。尽管如此，在您的公司环境中，一个缺乏经验且毫无戒心的用户只需点击一个链接或下载并运行一个恶意附件，就能为攻击者提供一个进入网络的立足点。大多数攻击链都是从电子邮件开始的。</p><p>公司意识到，网络犯罪分子瞄准员工，诱骗他们采取有害行动，例如向攻击者汇款。这就是为什么术语<a target="_blank" href="https://www.proofpoint.com/us/threat-reference/business-email-compromise" rel="external nofollow noopener noreferrer"><u/></a>(商务邮件妥协)变得如此普遍。</p><p>超过90%的<strong/>成功的<a target="_blank" href="https://www.cisa.gov/shields-up#:~:text=Think%20before%20you%20click.,numbers%2C%20or%20other%20sensitive%20information." rel="external nofollow noopener noreferrer"> <u>网络攻击都始于网络钓鱼邮件</u> </a>，因此在每个组织中优先考虑电子邮件安全是显而易见的。</p><p>网络钓鱼策略涉及许多创造性的方法，诱骗人们将敏感信息(如密码或信用卡号)提供给假装是可靠来源的人。</p><p>这通常是通过电子邮件或社交媒体消息来完成的，这些消息包含虚假网站的链接，这些网站看起来合法，但实际上旨在窃取受害者的信息。</p><p>但是，网络钓鱼也可能涉及自称来自合法组织并要求提供机密信息的人的电话或短信。</p><p><img src="../Images/8a13f8820ef3939d45d1483893296744.png" alt="business email compromise" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvYnVzaW5lc3MtZW1haWwtY29tcHJvbWlzZS0oYmVjKWpwZWcuanBlZw==?s=74939ed7336c9544cde725a24f1d2fa1"/> <br/>来源:<a target="_blank" href="https://www.fbi.gov/how-we-can-help-you/safety-resources/scams-and-safety/common-scams-and-crimes/business-email-compromise" rel="external nofollow noopener noreferrer"><u>FBI.gov</u></a></p><p>DMARC协议非常重要，因为它有助于防止电子邮件用户收到垃圾邮件和其他形式的恶意电子邮件。它通过允许电子邮件域所有者在其DNS记录中发布策略来实现这一点，这些策略指定哪些服务器有权代表他们发送电子邮件。</p><p>这使得攻击者更难发送看似来自受信任域的电子邮件，这有助于保护该域的声誉，并减少其用户收到的垃圾邮件和网络钓鱼电子邮件的数量。</p><h2 id="a-little-bit-of-history">一点历史</h2><p>DMARC是由包括Google、Microsoft、Yahoo和AOL在内的一些组织在2011年开发的安全协议。</p><p>DMARC的目标是解决<strong>电子邮件欺骗</strong>的问题，攻击者发送看似来自合法域的欺诈性电子邮件，诱骗收件人泄露敏感信息或点击恶意链接。</p><p>自成立以来，DMARC已被世界各地的组织广泛采用，作为一种保护其域免受电子邮件欺骗和网络钓鱼攻击的方法。DMARC目前得到了所有主流ISP的支持(比如Google、微软、Yahoo！等等。).</p><p>如今，DMARC仍然是希望提高电子邮件安全性并保护其品牌不被滥用的组织的重要工具。</p><p>那么，了解DMARC如何提高你的测试技能呢？这就是问题所在。</p><h2 id="how-does-dmarc-work">DMARC是如何工作的？</h2><p>当邮件服务器的电子邮件无法通过认证检查时，DMARC会提供帮助。因此，每封未能通过身份验证检查的电子邮件都必须通过DMARC策略的验证。</p><p>一个公司可以实施的三个DMARC政策<strong>:<br/></strong></p><ul><li><p><strong>“p = none”策略</strong>，有时也称为“monitor”策略，它告诉收件人的电子邮件提供商在电子邮件未通过DMARC时不要采取任何行动。</p></li><li><p><strong>“p = quarantine”策略</strong>将可疑电子邮件移动到不同的文件夹，如收件人的垃圾邮件文件夹，而不是收件箱。</p></li><li><p><strong>“p = reject”策略</strong>告诉提供商阻止任何未通过DMARC的电子邮件，因此该电子邮件甚至不会到达您的收件人。</p></li></ul><p>好的，<em>但是<strong>为什么DMARC没有SFP和DKIM </strong>就不能工作？</em>让我们来分解一下:</p><ul><li><p><strong> SPF </strong>允许发件人定义允许哪些IP地址发送特定域的邮件。</p></li><li><p><strong> DKIM </strong>提供加密密钥和数字签名，以验证电子邮件消息未被更改。</p></li><li><p><strong> DMARC </strong>将SPF和DKIM认证机制统一到一个通用框架中，并允许域所有者声明如果来自该域的电子邮件未通过授权测试，他们希望如何处理该电子邮件。<br/></p></li></ul><p>在网络安全方面，我们把中情局作为一切的基础。我们可以很容易地看到它是如何应用于电子邮件安全的:</p><p><strong>保密性</strong></p><p>SFP协议确保只允许来自某个域的声明IP发送电子邮件。</p><p><strong>诚信</strong></p><p>DKIM协议通过加密电子邮件并用数字签名验证它们来保证完整性。</p><p><strong>供货情况</strong></p><p>正如将未经授权的用户排除在组织数据之外很重要一样，数据应该在授权用户需要时随时可供他们使用。这意味着保持系统、网络和设备正常运行。因此，在您的组织中创建一个<strong> DMARC </strong>策略计划是确保可用性的一种方式。</p><p><img src="../Images/1358ed1d7b84e4733f0d73c47158ac03.png" alt="The CIA triad of email security protocols" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvdGhlLWNpYS10cmlhZC1vZi1lbWFpbC1zZWN1cml0eS1wcm90b2NvbHMucG5n?s=7f9f30aa9f8fa9e9dfaf7f36290329d8"/></p><h3 id="how-to-detect-an-improper-dmarc-configuration">如何检测不正确的DMARC配置</h3><p>需要注意的是，DMARC攻击对于不太知名的邮件服务提供商非常有效。这并不意味着Gmail、Yahoo Mail或ProtonMail等服务完全受到保护。如果攻击者想要发起成功的攻击，他们可以获得域信誉，从而绕过安全措施。</p><p>以下是您如何在道德黑客活动中提供这种域欺骗风险。</p><p>您可以使用下面的命令<br/> <img src="../Images/74f4a5e8df2b0e849d9a61c9112ba37f.png" alt="domain's DMARC policy" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvZG9tYWlucy1kbWFyYy1wb2xpY3kucG5n?s=735e718a680fce0f205bd97d413c8c4c"/>轻松地<strong>检查一个域的DMARC策略</strong></p><div class="content-highlight"><pre class="code-block"><code><code>dig _dmarc.domain txt +short</code></code></pre></div><div class="content-highlight"><pre class="code-block"><code>rua=mailto:eusebiu.boghici+dmarc@pentest-tools.com</code></pre></div><p>该部分告诉接收服务器将DMARC失败的集合报告发送到哪里。汇总DMARC报告每天发送给记录所属域的管理员。</p><p>如你所见，【Pentest-Tools.com】<a href="https://pentest-tools.com">域设置了<strong>拒绝</strong>策略，这意味着它会阻止任何未通过DMARC验证的电子邮件。</a></p><h2 id="how-to-exploit-a-dmarc-misconfiguration">如何利用DMARC错误配置</h2><p>开发过程非常简单。</p><p>我们将设置一个VPS(虚拟专用服务器)和一个域。我们将在VPS服务器上下载一个<a target="_blank" href="https://github.com/6point6/mail-spoofer" rel="external nofollow noopener noreferrer"> <u>工具</u> </a>并将其连接到新域。最后，我们将从购买的域名发送电子邮件。</p><p>考虑这样一个场景，我们有一个道德黑客商店，域名为<strong> hacking-goodies.shop </strong>。(请注意<a target="_blank" href="http://hacking-goodies.shop" rel="external nofollow noopener noreferrer"><strong><u>hacking-goodies . shop</u></strong></a>归<a href="https://pentest-tools.com"><u>Pentest-Tools.com</u></a>所有，我们给你在上面测试DMARC相关攻击的完全权限)。</p><p>首先，我们需要<strong>检查设置了什么DMARC策略</strong>。</p><div class="content-highlight"><pre class="code-block"><code>dig _dmarc.hacking-goodies.shop txt +short</code></pre></div><p>正如我们之前所说的，<strong> none策略</strong>不会做任何事情，这意味着它将允许邮件进入收件人的收件箱。</p><p>太好了！我们有完美的攻击方案。让我们继续获取域名和副总裁，并建立我们的攻击。</p><h3 id="getting-your-domain">获取您的域名</h3><p>首先，我们需要一个域，这样我们就可以安装<a target="_blank" href="https://github.com/6point6/mail-spoofer" rel="external nofollow noopener noreferrer"> <u>邮件欺骗器</u> </a>并发送电子邮件作为hacking-goodies.shop</p><p>为了简单起见，我们使用了<a target="_blank" href="http://godaddy.com" rel="external nofollow noopener noreferrer"> <u> GoDaddy </u> </a>作为新域，但是您可以使用任何符合您偏好的域提供者。</p><h3 id="setting-up-the-domain">设置域</h3><p>购买域后，您需要将名称服务器替换为Cloudflare自定义名称服务器。</p><p>在Cloudflare中，您将添加域并转到DNS面板。要使攻击成功，必须删除“DNS管理”下的任何内容。</p><p><img src="../Images/fae1afd920c85bc023ee0cc3a728d67c.png" alt="DNS management in Cloudfare" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvZG5zLW1hbmFnZW1lbnQtaW4tY2xvdWRmYXJlLnBuZw==?s=b5fd805401ebef1405957479aa385deb"/>在域名服务提供商的专用面板中向下滚动并更换给定的域名服务器。</p><p><img src="../Images/d8e92d2979828c8c0464d79951f61285.png" alt="Cloudfare nameservers" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvY2xvdWRmYXJlLW5hbWVzZXJ2ZXJzLnBuZw==?s=37a9fcae20ac8da034ba33d1c2071eae"/>现在您需要为下一步的配置文件获取一个API键。</p><p>前往https://dash.cloudflare.com/profile/api-tokens的<a target="_blank" href="https://dash.cloudflare.com/profile/api-tokens" rel="external nofollow noopener noreferrer">T3</a>，点击<strong>创建令牌</strong>。</p><p><img src="../Images/13e2b93054b10a75333f4143e6fed4fe.png" alt="create API Token" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvY3JlYXRlLWFwaS10b2tlbi5wbmc=?s=7ad32bd0d2d932bb3b4ae60abead565c"/>重定向后，点击<strong>编辑区域DNS </strong>旁边的<strong>使用模板</strong>。</p><p><img src="../Images/c048113307c1ff7870acffaae27b364e.png" alt="API Token template" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvYXBpLXRva2Vucy10ZW1wbGF0ZS5wbmc=?s=0d02c20a39e85ad99cd8dee076f31604"/>接下来，转到<strong>区域资源</strong>并选择您的域。</p><p><img src="../Images/8f9dd5d4bc5349469924e244a5823524.png" alt="Zone Resources" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvem9uZS1yZXNvdXJjZXMucG5n?s=35f4a11a0ec71fc00ad80c2858d23316"/>完成上述所有步骤后，您应该<strong>获得您的API密钥</strong>。请保存它，不要与其他任何人分享。</p><h3 id="setting-up-the-vps">设置VPS</h3><p>注意:您可能需要重复此步骤，因为VPS IPs可能会有不良声誉，因此，邮件服务将不会传递您的电子邮件。</p><p>对于VPS(虚拟专用服务器)部分，我们使用了<a target="_blank" href="http://vultr.com" rel="external nofollow noopener noreferrer"> Vultr </a>，因为他们似乎有最好的IP块声誉。</p><p>幸运的是，VPS不需要太多的资源，所以我们可以使用最便宜的资源，并且仍然可以得到一个正常运行的实例。</p><p>首先，当您创建VPS时，请注意使用您创建的域名准确设置主机名。</p><p><img src="../Images/fdbd5862eece9ef5c8dd7db02dfd261b.png" alt="Server Hostname" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvc2VydmVyLWhvc3RuYW1lLnBuZw==?s=3abe11cd0a6ddcbdda5922aadb252cd8"/>登录VPS后，输入以下<strong>命令</strong>:</p><div class="content-highlight"><pre class="code-block"><code>apt-get update &amp;&amp; apt-get install docker-compose</code></pre></div><p><br/>接下来，<strong>在实例上克隆GitHub库</strong>:<br/><img src="../Images/07b53a3a68086e506fb95e9b35e6dfd6.png" alt="GitHub directory cloned" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvY2xvbmluZy10aGUtZ2l0aHViLXJlcG9zaXRvcnkucG5n?s=9fd4dd6b7c2163afdd52b2e39367b586"/>git克隆<a target="_blank" href="https://github.com/6point6/mail-spoofer" rel="external nofollow noopener noreferrer"><u>https://github.com/6point6/mail-spoofer</u></a></p><p>转到<strong>新创建的目录。</strong></p><p>接下来，您需要编辑设置文件并<strong>添加您的域和API密钥</strong>。</p><p>用您的域名替换<strong>example.com</strong>，并在CLOUDFLARE <em> API </em>关键参数中添加您之前保存的API密钥。</p><p>完成上述所有步骤后，输入<strong> docker-compose up </strong>，耐心等待大约7-10分钟，让你的网络服务器启动。</p><h3 id="sending-the-phishing-email">发送网络钓鱼邮件</h3><p>你需要做的最后一步是把邮件发给受害者。</p><p>在浏览器中导航到您的VPS IP端口3333，并使用默认凭据登录:</p><ul><li><p>用户:管理员</p></li><li><p>密码:gophish</p></li></ul><p>转到发送配置文件选项卡，然后单击创建配置文件。</p><p><img src="../Images/b63906223704940173dfff133907d048.png" alt="sending profiles" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvc2VuZGluZ19wcm9maWxlcy5wbmc=?s=9e3c076aa36864a746511e48533d8cde"/></p><p><strong>用必要的信息替换输入</strong>。在我们的场景中，我们将按如下方式填写它们:</p><p>名称:测试</p><p>来自:<admin/></p><p>主机:后缀:25</p><p>完成所有这些后，填写收件人的电子邮件并发送出去。要知道，邮件会在5分钟左右到达目标。</p><h2 id="preventing-dmarc-email-security-risks">防范DMARC电子邮件安全风险</h2><p>太好了！您了解了利用DMARC错误配置在实践中是如何工作的，以及设置服务器来实现它是多么容易。</p><p>现在，如果你想保护自己，为你的同事或客户写令人信服的pentest报告，理解电子邮件分析的过程是非常必要的。</p><p>电子邮件标题包括电子邮件的技术细节，如发件人、收件人、路径、回邮地址和附件。</p><p>通常，这些细节足以确定电子邮件中是否有可疑/异常的内容，并决定对电子邮件采取进一步的行动。这个过程可以手动完成，也可以借助工具来完成。</p><h3 id="how-to-analyze-a-potentially-malicious-email">如何分析潜在的恶意电子邮件</h3><p>让我们换个角度，看看作为受害者，我们如何识别是否收到了网络钓鱼电子邮件。</p><p><img src="../Images/e951f548e825d099d847902f8a75f262.png" alt="phishing email example" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvcGhpc2hpbmctZW1haWwtZXhhbXBsZS5wbmc=?s=a33afe7fc452add2878b18f8c939e5e0"/>这封邮件看似来自我们的黑客商店领域，<em>但这真的是首席执行官要求我们重设密码的邮件吗？</em></p><p>这是一封伪造的电子邮件，但是，实际上，你无法辨别，因为这封电子邮件是以合法所有者的身份发送的。</p><p>如果我们点击<strong>查看原始消息</strong>，我们可以通过查看标题来检查它是否是一封网络钓鱼邮件。查看下图，并尝试了解如何检测泄漏。</p><p><img src="../Images/1ed4a68766e0de640fabad5b57350018.png" alt="checking for headers" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZG1hcmMtcHJvdG9jb2wvY2hlY2tpbmctaGVhZGVycy1zcG9vZmluZy1lbWFpbC5wbmc=?s=f443c6149def188c686f99a48fc1fc25"/>通过验证从部分收到的<strong>，很容易看到邮件来自的域。这一部分告诉我们电子邮件域的来源。</strong></p><p>如果电子邮件中的域名与接收部分中的不匹配，你应该忽略它(或者像一个好奇的黑客一样分析它)。</p><h2 id="statistics-that-show-why-dmarc-matters">显示DMARC重要性的统计数据</h2><ul><li><p>在全球范围内，<strong> 96%的网络钓鱼攻击</strong>通过电子邮件到达[ <a target="_blank" href="https://easydmarc.com/blog/phishing-statistics-easydmarc-report-january-june-2022/" rel="external nofollow noopener noreferrer"> <u>来源</u> </a> ]</p></li><li><p><strong>金融</strong>部门是这些类型攻击的最大目标[ <a target="_blank" href="https://easydmarc.com/blog/phishing-statistics-easydmarc-report-january-june-2022/" rel="external nofollow noopener noreferrer"> <u>来源</u> </a> ]。<br/></p></li></ul><p>我们自己的研究表明:</p><ul><li><p><strong>财富50强公司中有44%容易受到上述电子邮件欺骗的攻击</strong></p></li><li><p><strong>罗马尼亚13家银行中有10家</strong>容易受到由错误配置导致的DMARC电子邮件欺骗(76.92%)。</p></li></ul><h2 id="final-thoughts">最后的想法</h2><p>作为一名pentester，报告DMARC的错误配置是很重要的，因为它对组织来说是一个很大的威胁。</p><p>读完这篇文章后，您现在应该理解了错误配置DMARC策略的风险，以及正确使用DMARC的重要性。例如，APT团体可以从网络钓鱼活动开始，进入公司的内部网络，轻松部署勒索软件或破坏他们的资产和声誉。</p><p>通过发布DMARC策略并监控其使用情况，组织可以大大降低成为基于电子邮件的攻击目标的风险，并有助于保护其品牌和声誉。</p><p>总的来说，如果组织想要保护自己和用户免受电子邮件欺骗攻击，实施DMARC是一个重要的步骤。</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>